const publicKey = `-----BEGIN PUBLIC KEY-----
                                            MIIIIjANBgkqhkiG9w0BAQEFAAOCCA8AMIIICgKCCAEAxTV9u85h7BVOssl/kOE7
                                            zpjd0TjLt+iouU0AiULbteWPRs7IZVI0JvJNExYetbpY5vIHJ1gIIeltgOuk+ATc
                                            PO7hqNLp/UuJ12cTRO/SLk517T2/NHlRJ58EbjK8muFE8k3izLrJgWBS2kAGmgUz
                                            pKu+Wp7irO+vALliXf1R97XV8pPK+dns5bMlIsYbz3pg2bTL1uFYpjcxXk/xozV3
                                            y16JjEWwFbTYnFIGRvCCXISv8aKMAa1jqQVHLD8cezmJ5XaeXDD5ghoCMhjENGFA
                                            8rlx+VjGGpvWqPjtK4m6jo2+X6a0g1PnUwOeYv1JOOONiBcvZTnvByCYPNJeGNzS
                                            RVuUP/sLkNXtTO/itTq/lBB7isOyqBY9UBdcXQezRhfLDvGtPghX+eV26yxhp2Xw
                                            sUmJq9FMnkOHDDDw9QXSdeA9+lLg6sbzMk8l4CQdX9FOTgsaCN7eYhlRxG3s3bje
                                            8noVJbO+HyCQC+bVTo5JOGOxYyrE0FYRmIm+xqRhM6Xa+ChQvFr06DWiEEpIUDMn
                                            335d7mH9evOlnFiFOgDR7nHF3TcwST8EZWnhqc+TWNgZ17NADMY71/8jqh/fGWmD
                                            vrv6j/6fAk8RT683AHO86GtX79ofj/zwKerAoswEnc0wxme3eRMy36SnIrnhvUlD
                                            GrfGH7sg0ztQ2uXJxVYlvBEcIEUxRk2bUNClPkP0aDJHsJ+7khssbVs/j093Tr1B
                                            5HBsf+gnBdbW7pVUM3sx6T1/KC4S98uv+c3GXbfJo0zuxwiDTs22JCSSuyXBsSXY
                                            tgwnYRo1divKcgUPApzOEzUK9lV8n6eXNZ58zFRSLTIheJNqSm8V9TSppR5oFM74
                                            Re2YzXtfFey3EI49BLsjU5m+V5v7aqp7yWu0GY/+S1vFo1kFunK3BDVhkmJcU6sb
                                            sbAup6cfsaCAPed9GxJawycwQjRxfH1PFGOwayDoVFI2a+nBDvqn8lKHuokBD7B9
                                            oulMaMRc482z4bjmf6GooKdPAje7FnlF7vtThzyhficiUWM35mj/BgcudS4sK+fd
                                            z42g5BLa+nDYzizE//i+7E5dihXZuHVXZZ4vYDoEfLc/Xyc0e4tEdVSdNPupcYCO
                                            tWXLsbyI01ugMoDtknkaceSmXy3FS8CdND/jREHIPVJKKGuALnnDRTw0/ziUxbZM
                                            29u5TvSAIZ/rJqMFs1MXfVG6ZOgcgte5tVUVrW/q1xRb55zPlXC7FAgxxpymup1E
                                            qJV0px5sGzgkY27hpI262ugYKELX6ZIcTEjqwE+BgAheEC2PvP8O+1ApyZnlnxqj
                                            NksDkRTpXh7Up22vu90uDXDnqf10hyDj5kRvdgiJdV0jz8/iLHq5ZERDoh5hLn4N
                                            W3KdQ+vdVTtnL8vDljQmfg1QC+4ngpqaZHuHQTIk9yholCzGjjoT6GDpznqy2TWg
                                            d6Hos/s7hXojAV04OWhrCYWCVgkmiV1qBqS96xuW8ISY4nx5QVJe9cb1lK6BJ5zD
                                            DvYP6AAMZEa5esGAOdyLlBrgwVQUskP1euH3r3hqm4C2wRunWEeFrC2Bt9mJ5STa
                                            hBV4hOdhFeL+ifqzdJVJgyTizMYi5yaVeLXw4B1QDTyWeIJUZRall4jvg3fw51tv
                                            4VIBit6zc3Xe5MvfzoBIzv+lGctM0vMnALV/JKbmcQ4FACknDZpyUm5VGjmMcG9n
                                            5Hiqbf/qg10gc761bKfa3b3gJ4pu7IVAJbylhnkplJ8smk0IGdgcuPmv429GfBKQ
                                            NO04ReJJLpOCZFaeHUA4MKklfq/mOW4sc2o89U8NKJ+YTbNRNNcyzPA4ropu3Zmj
                                            7o75X4RdtH9Xd2m+rAHRiuwiqwIAkQKwi5cJ2qDHW5XeC5ijFqTKZNbsJ+Boz7a6
                                            GRxZHLLO5PxDCXCA+vRJxlPBOXrgaCNTqhIcY1FaPFbl/kmSl3/0GzwDeWqlzu/r
                                            voZXsWKCC23nxN5DvDbYVCgIZf/5uFsv/UTfeS7z3GZpjUkmooR44utMMjXY4Vt7
                                            97fzv20kk81va0IVQINHMkJpfzrt2DWTkRtKWD20H5XGR0Cfyw+QLJWkzDVUUVF4
                                            H4GBPoKa2PxzlHMTfxQ23dIRxJRqA2fmsc1QralrjNnCONidBRSHgy6N1S+apfhO
                                            9RCtULbPvJy3UEdDB6tKT0+rzfdIl7jFhylbUunPT5OqJI/CC8k+sSQQpFfl5ddF
                                            I8Czaj+9S2TKzjXxAyDqDB8dzuIgUwOxWStQdNieYSUlS3DLNZQ7C7cSt6K0fbRP
                                            2i9Sqwskh9sW15Y3Y4a2rAxlZP9QKdX1WbNDPPGb1YZQgf9mGWM1Fh3Ylp7f5z3V
                                            m+2H1yR1h4cfWB/zGH5SdXj1ZIlXtLXjyKsf2T2kcUf0+a3P+BVUyZzDq1Z92f9u
                                            KJ7dtKeaKgFw31pvdpc2mk4gylsRSvhGY9E6zGUuekVZupoXlYEz1YMEsNUvUAfX
                                            o1brWgxCOxsABgY0qLUfSQ1wDbEXyxPMCm2zuZwb86O9Uu7+bczG84cvgepzCFcl
                                            shhaBRPhVi5y51BcLKo82qDNvHgCs7gJaRVuRZ23tJj52Kg6yA67l5wenPUiFzjA
                                            iRCR0/on6KiT2/h1bgdcwueEIbMMScnrxTepe2LCypUqyRhCXXU5FfdtfYJ887sp
                                            k8r95szAHM+MBCCJs7UaoTGP42aG2215ol5Sge5cGxBSa8LoOsG+V6P1k6qydY4g
                                            Xt2BGVQbJOq9uZBQPG84540CAwEAAQ==
                                            -----END PUBLIC KEY-----
                                            `;
var lastEncrypt = {};
var id_encryption = 0;
var count = 0;
var id_custom = 1;
var custom_components = [];
var numOfConnections = -1;
var menusOpenedSchemas = {};
var selectedComponents = [];
var checkboxesIds = new Array();
var sourceSchemaWhenCopy = null;
var selectedComponentsToCopy = [];
var styleCompNative = {};
styleCompNative["color"] = "#023047";
styleCompNative["color-grad"] = "#023047";
styleCompNative["endpoint-color"] = "#000000";
styleCompNative["line-color"] = "#000000";

var styleCompCustom = {};
styleCompCustom["color"] = "#219ebc";
styleCompCustom["color-grad"] = "#219ebc";
styleCompCustom["endpoint-color"] = "#000000";
styleCompCustom["line-color"] = "#000000";

var needToSaveApp = false;

const componentsIconsType = {
    "Data Input": "../../static/icons/components_types/data_input.svg",
    "Data Output": "../../static/icons/components_types/data_output.svg",
    "Dataset Operations":
        "../../static/icons/components_types/datasets_operation.svg",
    "Data Transformation":
        "../../static/icons/components_types/data_transformation.svg",
    "Data Visualization":
        "../../static/icons/components_types/data_visualization.svg",
    "Descriptive Analysis":
        "../../static/icons/components_types/descriptive_analysis.svg",
    "Machine Learning":
        "../../static/icons/components_types/machine_learning.svg",
    "Text Analysis": "../../static/icons/components_types/text_analysis.svg",
    "My Components":
        "../../static/icons/components_types/custom_components.svg",
};
isNewConnection = true; //Flag que indica se uma conexão que está sendo feita,
//vem de uma conexão existente ou nova
var click = {
    x: 0,
    y: 0,
};

function generateDragConfig(box) {
    let dragConfig = {
        disabled: false,
        start: function (event) {
            click.x = event.clientX;
            click.y = event.clientY;
        },
        drag: function (event, ui) {
            let boundDocument = box.getBoundingClientRect();
            let currentScale = boundDocument.width / box.offsetWidth;

            let original = ui.originalPosition;
            ui.position = {
                left: (event.clientX - click.x + original.left) / currentScale,
                top: (event.clientY - click.y + original.top) / currentScale,
            };
        },
    };
    return dragConfig;
}
function bindEvents(schema) {
    componentsTemplates = getComponentsTemplates(); //Pegando JSON lido
    /*
  Clique duplo para remover conexão
  */
    //jsInstances[schema].bind("dblclick", function(connection, originalEvent) {
    //  jsInstances[schema].deleteConnection(connection);
    //});

    /*
  //Para identificar quando é uma conexão nova ou não
  */
    jsInstances[schema].bind("connectionDrag", function (connection) {
        if (connection.targetId.includes("jsPlumb") == true) {
            isNewConnection = true;
        } else {
            isNewConnection = false;
        }
    });

    /*
  Quando mover conexão, reajustar os valores dos labels
  */
    jsInstances[schema].bind("connectionMoved", function (ci) {
        connectionsInSource = jsInstances[schema]
            .select({ source: ci.originalSourceId })
            .getOverlay("label");
        currentLabel = ci.connection.getOverlay("label").getLabel();
        currentLabelIndex = parseInt(currentLabel.split("-")[0]);
        for (var iCon = 0; iCon <= connectionsInSource.length; iCon++) {
            if (connectionsInSource[iCon] != undefined) {
                if (connectionsInSource[iCon][0] != undefined) {
                    label = connectionsInSource[iCon][0].getLabel();
                    labelIndex = parseInt(label.split("-")[0]);
                    if (currentLabelIndex < labelIndex) {
                        var newLabel =
                            (labelIndex - 1).toString() +
                            "-" +
                            label.split("-")[1];
                        connectionsInSource[iCon][0].setLabel(newLabel);
                    }
                }
            }
        }

        connectionsInTarget = jsInstances[schema]
            .select({ target: ci.originalTargetId })
            .getOverlay("label");
        if (ci.originalTargetId != ci.newTargetId) {
            currentLabel = ci.connection.getOverlay("label").getLabel();
            currentLabelIndex = parseInt(currentLabel.split("-")[1]);
            for (var iCon = 0; iCon <= connectionsInTarget.length; iCon++) {
                if (connectionsInTarget[iCon] != undefined) {
                    if (connectionsInTarget[iCon][0] != undefined) {
                        label = connectionsInTarget[iCon][0].getLabel();
                        labelIndex = parseInt(label.split("-")[1]);
                        if (currentLabelIndex < labelIndex) {
                            var newLabel =
                                label.split("-")[0] +
                                "-" +
                                (labelIndex - 1).toString();
                            connectionsInTarget[iCon][0].setLabel(newLabel);
                        }
                    }
                }
            }
            ci.connection.removeOverlay("label");
            nConnectionsInSource = jsInstances[schema].getConnections({
                source: ci.originalSourceId,
            }).length;
            nConnectionsInTarget = jsInstances[schema].getConnections({
                target: ci.newTargetId,
            }).length;
            var nConn =
                nConnectionsInSource.toString() +
                "-" +
                nConnectionsInTarget.toString();
            //Adionando overlay (UI para o label)
            ci.connection.addOverlay([
                "Label",
                {
                    label: nConn,
                    location: 0.5,
                    labelStyle: { fill: "black", color: "white" },
                    id: "label",
                },
            ]);
        }
    });

    /*
  Evitar auto-conexão, conexões repetidas e respeitar input_dim
  */
    jsInstances[schema].bind("beforeDrop", function (connection) {
        //Utiliza as possíveis conexões que existem no alvo da conexão atual (que será adicionada)
        connectionsInTarget = jsInstances[schema]
            .select({ target: connection.targetId })
            .getLabel();
        hasNotCon = true;
        minDim = true;

        var connectionsTarget = jsInstances[schema].getConnections({
            target: connection.targetId,
        });

        //OUTRA FORMA DE CAPTURAR CONEXÕES
        //var connnections = jsInstances[schema].getConnections({source:src});

        nConnections = connectionsInTarget.length;

        selectedConnectionsInTarget = [];
        //Selecionar todas os componentes que estão no target
        for (var iCon = 0; iCon <= nConnections - 1; iCon++) {
            selectedConnectionsInTarget.push(
                connectionsInTarget[iCon][1].sourceId
            );
        }
        //Se a conexão for existente, eliminar a entrada redundante
        if (isNewConnection == false) {
            var index = selectedConnectionsInTarget.indexOf(
                connection.sourceId
            );
            if (index !== -1) selectedConnectionsInTarget.splice(index, 1);
        }

        nConnections = selectedConnectionsInTarget.length;
        //Se existir alguma conexão com o mesmo componente source, então a conexão é redundante
        for (var iCon = 0; iCon <= nConnections - 1; iCon++) {
            if (selectedConnectionsInTarget[iCon] == connection.sourceId) {
                // && isNewConnection==true) {
                hasNotCon = false;
            }
        }
        comp = componentsTemplates[connection.targetId.split("-xx-")[0]];
        if ("input_dim" in comp) {
            if (nConnections >= comp["input_dim"]) {
                minDim = false;
            }
        }

        // connectionsJson = {}
        // connectionsJson["jsPlumb"] = jsInstances[schema]
        // connectionsJson["connection"] = connection["connection"]

        // var info = {
        //   "attachConnection": connectionsJson
        // }

        // if(undoCommands.length == 5)
        // undoCommands.pop()

        // undoCommands.unshift(info);

        return (
            connection.sourceId !== connection.targetId && minDim && hasNotCon
        );
    });

    /*
  Quando remover conexão, reordenar labels
  */
    jsInstances[schema].bind("connectionDetached", function (ci) {
        //Valores a partir da fonte (source)
        connectionsInSource = jsInstances[schema]
            .select({ source: ci.sourceId })
            .getOverlay("label");
        currentLabel = ci.connection.getOverlay("label").getLabel();
        currentLabelIndex = parseInt(currentLabel.split("-")[0]);
        for (var iCon = 0; iCon <= connectionsInSource.length; iCon++) {
            if (connectionsInSource[iCon] != undefined) {
                if (connectionsInSource[iCon][0] != undefined) {
                    label = connectionsInSource[iCon][0].getLabel();
                    labelIndex = parseInt(label.split("-")[0]);
                    if (currentLabelIndex < labelIndex) {
                        var newLabel =
                            (labelIndex - 1).toString() +
                            "-" +
                            label.split("-")[1];
                        connectionsInSource[iCon][0].setLabel(newLabel);
                    }
                }
            }
        }
        //Valores do destino (target)
        connectionsInTarget = jsInstances[schema]
            .select({ target: ci.targetId })
            .getOverlay("label");
        currentLabel = ci.connection.getOverlay("label").getLabel();
        currentLabelIndex = parseInt(currentLabel.split("-")[1]);
        for (var iCon = 0; iCon <= connectionsInTarget.length; iCon++) {
            if (connectionsInTarget[iCon] != undefined) {
                if (connectionsInTarget[iCon][0] != undefined) {
                    label = connectionsInTarget[iCon][0].getLabel();
                    labelIndex = parseInt(label.split("-")[1]);
                    if (currentLabelIndex < labelIndex) {
                        var newLabel =
                            label.split("-")[0] +
                            "-" +
                            (labelIndex - 1).toString();
                        connectionsInTarget[iCon][0].setLabel(newLabel);
                    }
                }
            }
        }
        connectionsJson = {};
        connectionsJson["jsPlumb"] = jsInstances[schema];
        connectionsJson["connection"] = ci.connection;
        // setTimeout(function () {
        //   if (document.getElementById(ci.connection.targetId) && document.getElementById(ci.connection.sourceId)) {
        //     var info = {
        //       "dettachConnection": connectionsJson
        //     }
        //     if(undoCommands.length == 5)
        //       undoCommands.pop()

        //     undoCommands.unshift(info);
        //     console.log(undoCommands);
        //   }
        // }, 10);
    });

    /*
  Adiciona um label à uma nova conexão recém adicionada
  */
    jsInstances[schema].bind("connection", function (ci) {
        currentLabel = ci.connection.getOverlay("label");
        //Só adiciona label, caso ainda não tenha um na conexão
        if (currentLabel == undefined) {
            nConnectionsInSource = jsInstances[schema].getConnections({
                source: ci.sourceId,
            }).length;
            nConnectionsInTarget = jsInstances[schema].getConnections({
                target: ci.targetId,
            }).length;
            var nConn =
                nConnectionsInSource.toString() +
                "-" +
                nConnectionsInTarget.toString();
            //Adionando overlay (UI para o label)
            ci.connection.addOverlay([
                "Label",
                {
                    label: nConn,
                    location: 0.5,
                    labelStyle: { fill: "black", color: "white" },
                    id: "label",
                },
            ]);
        }
    });
}
/*Fim de bindEvents */

/**Cria um box com os modelos do componente */
function saveSelectedModels(checkboxIds, componentName, currentApplication) {
    var models_ids = [];
    for (var i = 0; i < checkboxIds.length; i++) {
        var checkbox = document.getElementById(checkboxIds[i]);
        if (checkbox.checked == true) {
            models_ids.push(checkboxIds[i].split("_").pop(-1));
        }
    }

    if (models_ids.length == 1)
        saveComponentsModels(models_ids, componentName, currentApplication);
    else messagesLog("Select one model");
}

function deleteSelectedModels(checkboxIds, buttonId, currentApplication) {
    var models_ids = [];
    for (var i = 0; i < checkboxIds.length; i++) {
        var checkbox = document.getElementById(checkboxIds[i]);
        if (checkbox.checked == true) {
            models_ids.push(checkboxIds[i].split("_").pop(-1));
        }
    }

    for (var i in models_ids) {
        document.getElementById("Row_" + models_ids[i]).remove();
        var index = checkboxIds.indexOf("checkbox_" + models_ids[i]);
        if (index !== -1) {
            checkboxIds.splice(index, 1);
        }
    }

    deleteComponentsModels(models_ids, currentApplication, buttonId);
}

function formatDate(date) {
    var d = new Date(date),
        month = "" + (d.getMonth() + 1),
        day = "" + d.getDate(),
        year = d.getFullYear();

    if (month.length < 2) month = "0" + month;
    if (day.length < 2) day = "0" + day;

    var time =
        d.getUTCHours() + ":" + d.getUTCMinutes() + ":" + d.getUTCSeconds();
    var modelTime = [day, month, year].join("/") + " " + time;

    return modelTime;
}

function showNoModelsMessage(idName, divIdIndex) {
    var modelsDiv = document.getElementById(
        "listOfModels_" + idName + "-xx-" + divIdIndex
    );
    var menu = document.getElementById("menu_" + idName + "-xx-" + divIdIndex);
    document.getElementById(
        "deleteModels_" + idName + "-xx-" + divIdIndex
    ).style.display = "none";
    if (
        !document.getElementById(
            "noModelsMessage_" + idName + "-xx-" + divIdIndex
        )
    ) {
        message = document.createElement("p");
        message.setAttribute(
            "id",
            "noModelsMessage_" + idName + "-xx-" + divIdIndex
        );
        message.setAttribute("style", "text-align: center; margin-top: 10%;");
        message.textContent = "No models to show";
        modelsDiv.appendChild(message);
        menu.appendChild(modelsDiv);
    }
}

//Função para arredondar o valor metric
function round(value, decimals) {
    return Number(Math.round(value + "e" + decimals) + "e-" + decimals);
}

//Função para gerar um header da tabela de modelos específicos para cada componente (de acordo com a quantidade de parâmetros)
function generateHeader(modelsKeys, componentModels) {
    var modelsHeaders;
    for (var i = 0; i < modelsKeys.length; i++) {
        for (var j = 0; j < componentModels[modelsKeys[i]].length; j++) {
            modelsHeaders = [];
            if (componentModels[modelsKeys[i]][j]["description"] != null) {
                modelsHeaders.push("Description");
            }
            if (componentModels[modelsKeys[i]][j]["date"] != null) {
                modelsHeaders.push("Datetime");
            }
            // console.log(typeof componentModels[modelsKeys[i]][j]['metric']);
            if (componentModels[modelsKeys[i]][j]["metric"] != null) {
                modelsHeaders.push("Metric");
            }
            if (componentModels[modelsKeys[i]][j]["metric_name"] != null) {
                modelsHeaders.push("Metric Name");
            }
            modelsHeaders.push("Selected");
        }
    }
    return modelsHeaders;
}

function createModelsTable(idName, divIdIndex, componentModels) {
    var menu = document.getElementById("menu_" + idName + "-xx-" + divIdIndex);
    var modelsDiv = document.getElementById(
        "listOfModels_" + idName + "-xx-" + divIdIndex
    );

    tableOfModels = document.createElement("table");
    tableOfModels.setAttribute("border", "1");
    tableOfModels.setAttribute("style", "width: 100%; text-align: center;");
    tableOfModels.setAttribute(
        "id",
        "tableOfModels_" + idName + "-xx-" + divIdIndex
    );
    tableOfModels.setAttribute("class", "instances-table");
    tableOfModels.style.visibility = "visible";

    modelsKeys = Object.keys(componentModels);
    header = generateHeader(modelsKeys, componentModels);
    trHeader = document.createElement("tr");
    trHeader.setAttribute("style", "background-color: #C4C4C4");
    trHeader.setAttribute("id", "modelsHeader_" + idName + "-xx-" + divIdIndex);

    for (var h in header) {
        var th = document.createElement("th");
        th.setAttribute("id", header[h] + " " + idName + "-xx-" + divIdIndex);
        th.textContent = header[h];
        trHeader.appendChild(th);
    }
    tableOfModels.appendChild(trHeader);

    checkboxesIds = [];
    var checkboxesArr = [];
    for (var i = 0; i < modelsKeys.length; i++) {
        for (var j = 0; j < componentModels[modelsKeys[i]].length; j++) {
            var newRow = document.createElement("tr");
            newRow.setAttribute(
                "id",
                "Row_" + componentModels[modelsKeys[i]][j]["model_id"]
            );
            newRow.setAttribute("style", "width: 100%;");

            if (componentModels[modelsKeys[i]][j]["description"] != null) {
                modelDescription = document.createElement("td");
                modelDescription.setAttribute(
                    "id",
                    componentModels[modelsKeys[i]][j]["model_id"]
                );
                modelDescription.textContent =
                    componentModels[modelsKeys[i]][j]["description"];
                newRow.appendChild(modelDescription);
            }

            if (componentModels[modelsKeys[i]][j]["date"] != null) {
                modelDate = document.createElement("td");
                modelDate.setAttribute(
                    "id",
                    componentModels[modelsKeys[i]][j]["model_id"]
                );
                modelDate.textContent = formatDate(
                    componentModels[modelsKeys[i]][j]["date"]
                );
                newRow.appendChild(modelDate);
            }

            if (componentModels[modelsKeys[i]][j]["metric"] != null) {
                var metricStr =
                    componentModels[modelsKeys[i]][j]["metric"].toString();
                var metricRounded;
                if (metricStr.includes("e")) {
                    splittedStr = metricStr.split("e");
                    metricRounded = splittedStr[0];
                } else
                    metricRounded = componentModels[modelsKeys[i]][j]["metric"];
                metricRounded = round(metricRounded, 4);

                metric = document.createElement("td");
                metric.setAttribute(
                    "id",
                    componentModels[modelsKeys[i]][j]["model_id"]
                );
                metric.textContent = metricRounded;
                newRow.appendChild(metric);
            }

            if (componentModels[modelsKeys[i]][j]["metric_name"] != null) {
                metric_name = document.createElement("td");
                metric_name.setAttribute(
                    "id",
                    componentModels[modelsKeys[i]][j]["model_id"]
                );
                metric_name.textContent =
                    componentModels[modelsKeys[i]][j]["metric_name"];
                newRow.appendChild(metric_name);
            }

            selected_model = document.createElement("td");
            x = document.createElement("input");
            x.setAttribute(
                "id",
                "checkbox_" + componentModels[modelsKeys[i]][j]["model_id"]
            );
            x.type = "checkbox";

            x.setAttribute("class", "checkbox");
            checkboxesIds.push(
                "checkbox_" + componentModels[modelsKeys[i]][j]["model_id"]
            );
            checkboxesArr.push(x);
            if (componentModels[modelsKeys[i]][j]["selected_model"] == true) {
                x.checked = true;
            } else x.checked = false;

            selected_model.appendChild(x);
            newRow.appendChild(selected_model);

            tableOfModels.appendChild(newRow);
        }
    }

    for (var ch in checkboxesArr) {
        checkboxesArr[ch].addEventListener("click", function () {
            handleDeleteBtn(checkboxesIds, idName, divIdIndex);
        });
    }
    modelsDiv.appendChild(tableOfModels);
    menu.appendChild(modelsDiv);
}

function handleDeleteBtn(checkboxesIds, idName, divIdIndex) {
    var checkedCounter = 0;
    for (var i in checkboxesIds) {
        if (document.getElementById(checkboxesIds[i]).checked == true) {
            checkedCounter++;
        }
    }
    if (checkedCounter == 0)
        document.getElementById(
            "deleteModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "none";
    else
        document.getElementById(
            "deleteModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "inline-block";
}

function renderModels(idName, divIdIndex, componentName) {
    var updatedComponentName = document.getElementById(
        "name_" + componentName + divIdIndex
    ).value;

    var modelsBtn = document.getElementById(
        "models_" + idName + "-xx-" + divIdIndex
    );
    var listParameters = document.getElementById(
        "listParameters" + idName + "-xx-" + divIdIndex
    );
    if (modelsBtn.innerHTML == "Models") {
        var componentModels = getComponentModels(
            updatedComponentName,
            currentApplication
        );
        modelsKeys = Object.keys(componentModels);
        var modelsLength;

        for (var i = 0; i < modelsKeys.length; i++) {
            for (var j = 0; j < componentModels[modelsKeys[i]].length; j++) {
                modelsLength = componentModels[modelsKeys[i]].length;
            }
        }
        modelsBtn.innerHTML = "Params";
        listParameters.style.display = "none";
        document.getElementById(
            "saveModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "inline-block";
        document.getElementById(
            "deleteModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "inline-block";
        document.getElementById(
            "listOfModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "block";

        if (!modelsLength) {
            showNoModelsMessage(idName, divIdIndex);
        } else {
            if (
                document.getElementById(
                    "noModelsMessage_" + idName + "-xx-" + divIdIndex
                )
            ) {
                document
                    .getElementById(
                        "noModelsMessage_" + idName + "-xx-" + divIdIndex
                    )
                    .remove();
            }
            if (
                document.getElementById(
                    "tableOfModels_" + idName + "-xx-" + divIdIndex
                )
            ) {
                document
                    .getElementById(
                        "tableOfModels_" + idName + "-xx-" + divIdIndex
                    )
                    .remove();
            }
            createModelsTable(idName, divIdIndex, componentModels);
        }
    } else {
        modelsBtn.innerHTML = "Models";
        if (
            document.getElementById(
                "tableOfModels_" + idName + "-xx-" + divIdIndex
            )
        ) {
            document.getElementById(
                "tableOfModels_" + idName + "-xx-" + divIdIndex
            ).style.display = "none";
        }
        document.getElementById(
            "listParameters" + idName + "-xx-" + divIdIndex
        ).style.display = "grid";
        document.getElementById(
            "saveModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "none";
        document.getElementById(
            "deleteModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "none";
        document.getElementById(
            "listOfModels_" + idName + "-xx-" + divIdIndex
        ).style.display = "none";
    }
}
/*
Função para bloquear caso o usuário tente salvar a aplicação sem nenhum checkbox do multiselect ativo
*/

var disabledCheckbox; //Armazenar o checkbox que será desativado quando necessário
function verifyMultiSelect(options, divIdIndex, parameter, currentCheckbox) {
    options = options.split(",");
    var checkboxes = [];
    var checkedCount = 0;
    var checked;
    for (var i = 0; i < options.length; i++) {
        checkboxes.push(
            document.getElementById(
                "checkboxMultiSelect " +
                    options[i] +
                    "_" +
                    divIdIndex +
                    "_" +
                    parameter
            )
        );
    }
    for (var i = 0; i < checkboxes.length; i++) {
        if (checkboxes[i].checked == true) {
            checkedCount++;
            checked = checkboxes[i];
        }
    }
    if (checkedCount == 1) {
        checked.disabled = true;
        disabledCheckbox = checked;
    } else {
        if (disabledCheckbox) {
            disabledCheckbox.disabled = false;
        }
    }
}

function encryptText(publicKey, text) {
    jsencrypt = new JSEncrypt();
    jsencrypt.setPublicKey(publicKey);
    return jsencrypt.encrypt(text);
}

function encryptTextAreaBQ(textArea, id) {
    info = textArea.value;
    if (info != "") {
        if (info != lastEncrypt[id] && info.length < 3000) {
            try {
                info = JSON.parse(info);
            } catch {
                messagesLog("Json Not Valid");
            }
            if ("private_key" in info) {
                pk = info["private_key"];
                delete info["private_key"];
            } else {
                messagesLog("Invalid Big Query Service Account Info");
                return false;
            }

            encrypted = encryptText(publicKey, pk).concat(
                encryptText(publicKey, JSON.stringify(info))
            );
            textArea.value = encrypted;
        }

        lastEncrypt[id] = encrypted;
    }
}

/**
Cria conteúdo do formulário de parâmetros dos componentes
*/
function createForm(
    componentTemplate,
    componentParameters,
    idName,
    divIdIndex,
    componentName,
    idCanvas
) {
    var gridAreas = [];
    //Object.keys(componentParameters)
    newComp = false;
    if (Object.keys(componentParameters).length == 0) {
        newComp = true;
        //componentTemplate = componentParameters;
    }
    //Cria formulário que é inserido no menu

    var wrapper = document.getElementById(
        "wrapper_menu_" + idName + "-xx-" + divIdIndex
    );

    form = document.createElement("form");
    form.setAttribute("id", "parameters_form_" + idName + "-xx-" + divIdIndex);
    form.setAttribute("style", "overflow-x: hidden; text-align: center;");

    var listParameters = document.createElement("div");
    listParameters.setAttribute("class", "parametersGrid");
    listParameters.setAttribute(
        "id",
        "listParameters" + idName + "-xx-" + divIdIndex
    );

    var windowHeader = document.createElement("div");
    windowHeader.setAttribute(
        "style",
        "margin-top: 15px; position: relative; width: 100%; display: flex;"
    );

    var title = document.createElement("p");
    title.textContent = idName;
    componentTemplate.component_type !== "model"
        ? (title.style.margin = "0 auto")
        : null;
    windowHeader.appendChild(title);
    form.appendChild(windowHeader);

    if (componentTemplate.component_type == "model") {
        listOfModels = document.createElement("div");
        listOfModels.setAttribute(
            "id",
            "listOfModels_" + idName + "-xx-" + divIdIndex
        );
        listOfModels.setAttribute("style", "margin-top: 15px;");

        document
            .getElementById("menu_" + idName + "-xx-" + divIdIndex)
            .appendChild(listOfModels);

        var buttonsDiv = document.createElement("div");
        buttonsDiv.setAttribute(
            "style",
            "position: relative; margin-top: 5px;"
        );
        modelsButton = document.createElement("button");
        modelsButton.setAttribute("class", "modelsButton");
        modelsButton.setAttribute("type", "button");
        modelsButton.setAttribute(
            "id",
            "models_" + idName + "-xx-" + divIdIndex
        );
        modelsButton.setAttribute(
            "onclick",
            "renderModels('" +
                idName +
                "', '" +
                divIdIndex +
                "', '" +
                componentName +
                "');"
        );
        modelsButton.innerHTML = "Models";
        buttonsDiv.appendChild(modelsButton);

        saveButton = document.createElement("button");
        saveButton.style.visibility = "hidden";
        saveButton.setAttribute("class", "modelsButton");
        saveButton.setAttribute("style", "display: none");
        saveButton.setAttribute("type", "button");
        saveButton.setAttribute(
            "id",
            "saveModels_" + idName + "-xx-" + divIdIndex
        );
        saveButton.innerHTML = "Save";
        saveButton.addEventListener("click", function (event) {
            saveSelectedModels(
                checkboxesIds,
                componentName,
                currentApplication
            );
            event.preventDefault();
        });
        buttonsDiv.appendChild(saveButton);

        deleteModelButton = document.createElement("button");
        deleteModelButton.style.visibility = "hidden";
        deleteModelButton.setAttribute("class", "modelsButton");
        deleteModelButton.setAttribute("style", "display: none");
        deleteModelButton.setAttribute("type", "button");
        deleteModelButton.setAttribute(
            "id",
            "deleteModels_" + idName + "-xx-" + divIdIndex
        );
        deleteModelButton.innerHTML = "Delete";

        var idStr = "deleteModels_" + idName + "-xx-" + divIdIndex;
        deleteModelButton.addEventListener("click", function (event) {
            if (confirm("Delete selected model(s)?")) {
                deleteSelectedModels(checkboxesIds, idStr, currentApplication);
                event.preventDefault();
            }
        });
        buttonsDiv.appendChild(deleteModelButton);

        windowHeader.appendChild(buttonsDiv);
    }
    nFormEntries = 0;
    for (var parameter in componentTemplate) {
        if (
            parameter == "help" ||
            parameter == "component_type" ||
            parameter == "input_dim" ||
            parameter == "help_link" ||
            parameter == "grid_config" ||
            parameter == "icon_type"
        ) {
            continue;
        } else {
            gridAreas.push(parameter);
            if (!(parameter in componentParameters) && newComp == false) {
                var key = "Aliases_" + idName;
                if (parametersAliases[key] != undefined) {
                    needToSaveApp = true;
                    componentParameters[parameter] =
                        componentParameters[parametersAliases[key][parameter]];
                    delete componentParameters[
                        parametersAliases[key][parameter]
                    ];
                }
            }
        }

        var elementList = document.createElement("div");
        elementList.setAttribute("class", "input-field");

        if (newComp == true) {
            var value = componentTemplate[parameter];
        } else {
            var value = componentParameters[parameter];
        }
        templateValue = componentTemplate[parameter];

        var label = document.createElement("label");
        label.setAttribute("class", "label-style");
        label.innerHTML = parameter;
        elementList.appendChild(label);

        commonRender = true;
        valueType = typeof templateValue;
        isArray = templateValue instanceof Array;
        if (typeof value == "undefined") {
            value = "";
        }
        //Se for um object (dicionario)
        if (valueType == "object" && isArray == false) {
            if ("textarea" in templateValue) {
                generateCustomGrid = true;
                elementList.style.width = "calc(100% - 43.4px)";
                var input = document.createElement("textarea");
                if (typeof value == "object" && "textarea" in value) {
                    value = value["textarea"];
                }
                input.value = value.replace(/(?:\\r\\n|\\r|\\n)/g, "\n");
                input.setAttribute("name", parameter); //name recebe o nome do parametro (assim como label)
                // input.setAttribute("class", "input-field")
                input.setAttribute("class", "textarea_input");
                input.setAttribute("rows", "5");
                input.setAttribute("cols", "50");
                if ("help" in templateValue) {
                    input.setAttribute("title", templateValue["help"]);
                }
                commonRender = false;
                if (
                    "encrypted" in templateValue &&
                    templateValue["encrypted"]
                ) {
                    lastEncrypt[id_encryption] = value;
                    input.setAttribute(
                        "onblur",
                        "encryptTextAreaBQ(this, " + id_encryption++ + ")"
                    );
                }
            } else if ("select" in templateValue) {
                var input = document.createElement("select");
                input.setAttribute("name", parameter); //name recebe o nome do parametro (assim como label)
                input.setAttribute(
                    "id",
                    idName + "-xx-" + divIdIndex + "-xx-" + parameter
                );
                //input.value = value;

                if ("help" in templateValue) {
                    input.setAttribute("title", templateValue["help"]);
                }

                if (idName == "Load Data Objects" && parameter == "dataset") {
                    var option = document.createElement("option");
                    option.text = componentParameters["dataset"];
                    option.value = componentParameters["dataset"];
                    input.appendChild(option);
                } else if (
                    idName == "Load Data Objects" &&
                    parameter == "dataset_learning"
                ) {
                    var option = document.createElement("option");
                    option.text = componentParameters["dataset_learning"];
                    option.value = componentParameters["dataset_learning"];
                    input.appendChild(option);
                } else if (
                    idName == "Big Query Input" ||
                    (idName == "Big Query Output" && parameter == "credentials")
                ) {
                    var option = document.createElement("option");
                    option.text = componentParameters["credentials"];
                    option.value = componentParameters["credentials"];
                    input.appendChild(option);
                }

                templateValue["select"].forEach(function (item) {
                    var option = document.createElement("option");
                    option.text = item;
                    option.value = item;
                    if (newComp == false && item == value) {
                        option.selected = "true";
                    }
                    input.appendChild(option);
                });
                commonRender = false;
            } else if ("password" in templateValue) {
                var input = document.createElement("input");
                input.setAttribute("type", "password");
                input.setAttribute("autocomplete", "new-password");
                if (newComp == true) {
                    valueToRender = value["password"];
                } else {
                    valueToRender = value;
                }
                input.setAttribute(
                    "value",
                    JSON.stringify(valueToRender).replace(/"/g, "")
                );
                input.setAttribute("name", parameter); //name recebe o nome do parametro (assim como label)

                input.setAttribute("size", "50");
                if ("help" in templateValue) {
                    input.setAttribute("title", templateValue["help"]);
                }
                commonRender = false;
            } else if ("text" in templateValue) {
                var input = document.createElement("input");
                if (parameter == "password") {
                    input.setAttribute("type", "password");
                    input.setAttribute("autocomplete", "new-password");
                } else {
                    input.setAttribute("type", "text");
                }

                if (newComp == true) {
                    if ("text" in templateValue) {
                        valueToRender = value["text"];
                    } else {
                        valueToRender = value["textlist"];
                    }
                } else {
                    if (value == "") {
                        if ("text" in templateValue) {
                            valueToRender = templateValue["text"];
                        } else {
                            valueToRender = templateValue["textlist"];
                        }
                    } else {
                        valueToRender = value;
                    }
                }

                input.setAttribute(
                    "value",
                    JSON.stringify(valueToRender).replace(/"/g, "")
                );
                input.setAttribute("name", parameter); //name recebe o nome do parametro (assim como label)
                input.setAttribute("size", "50");
                //if ("text" in templateValue){
                //  input.setAttribute("maxlength", "5");
                //}
                if ("help" in templateValue) {
                    input.setAttribute("title", templateValue["help"]);
                }
                commonRender = false;
            } else if ("subform" in templateValue) {
                generateCustomGrid = true;
                elementList.style.width = "calc(100% - 43.4px)";
                //Adicionar botões de mostrar/esconder e nova entrada

                var input = document.createElement("div");
                input.setAttribute("class", "input-field subformDiv");
                input.setAttribute("name", parameter);
                elementList.appendChild(input);

                var addEntry = document.createElement("a");
                addEntry.setAttribute("class", "subform-buttons add-btn");

                if (idName == "User Input") {
                    var isLocked = true;

                    var lockIcon = document.createElement("a");
                    lockIcon.setAttribute(
                        "style",
                        "width: 48px; height: 48px; background-repeat: no-repeat; position:absolute; left: 80px; cursor: pointer; background-position: center; background-image: url('../../static/icons/lock_icon.svg')"
                    );
                    lockIcon.setAttribute("title", "Lock fields");

                    lockIcon.addEventListener("click", function () {
                        if (isLocked) {
                            lockIcon.style.backgroundImage =
                                "url('../../static/icons/unlock_icon.svg')";

                            entriesWrapper
                                .querySelectorAll(".subInputRow")
                                .forEach(function (elem) {
                                    elem.querySelector(
                                        "a"
                                    ).style.pointerEvents = "auto";
                                    elem.querySelector(
                                        "input"
                                    ).readOnly = false;
                                });
                        } else {
                            lockIcon.style.backgroundImage =
                                "url('../../static/icons/lock_icon.svg')";
                            entriesWrapper
                                .querySelectorAll(".subInputRow")
                                .forEach(function (elem) {
                                    elem.querySelector(
                                        "a"
                                    ).style.pointerEvents = "none";
                                    elem.querySelector("input").readOnly = true;
                                });
                        }
                        isLocked = !isLocked;
                    });
                    input.appendChild(lockIcon);
                }
                input.appendChild(addEntry);
                elementList.appendChild(input);

                let subParameters = Object.keys(templateValue["subform"][0]);
                addEntry.idMenu = "menu_" + idName + "-xx-" + divIdIndex;

                let entriesWrapper = document.createElement("div");
                entriesWrapper.setAttribute(
                    "id",
                    idName + "-xx-" + divIdIndex + "-xx-" + parameter
                );
                entriesWrapper.setAttribute(
                    "style",
                    "max-height: 400px; overflow: auto;"
                );
                if (newComp == true) {
                    nMaxEntries = 1;
                } else {
                    nMaxEntries = value.length; //templateValue["max_entries"]
                }
                for (var i = 0; i < nMaxEntries; i++) {
                    var row = document.createElement("div");
                    row.setAttribute("class", "subInputRow");
                    for (
                        var iSubParam = 0;
                        iSubParam < subParameters.length;
                        iSubParam++
                    ) {
                        let subInputWrapper = document.createElement("div");
                        subInputWrapper.setAttribute("class", "subInput-field");

                        let subInputLabel = document.createElement("label");
                        subInputLabel.setAttribute("class", "label-style");
                        subInputLabel.textContent = subParameters[iSubParam];

                        subInputWrapper.appendChild(subInputLabel);

                        let subInput = document.createElement("input");

                        if (subParameters[iSubParam] == "attribute") {
                            idName == "User Input"
                                ? (subInput.readOnly = true)
                                : null;
                            subInput.style.fontWeight = "700";
                        }
                        subInput.setAttribute("name", subParameters[iSubParam]);
                        subInputWrapper.appendChild(subInput);

                        if (newComp == true) {
                            subInput.setAttribute("value", "");
                        } else {
                            subInput.setAttribute(
                                "value",
                                value[i][subParameters[iSubParam]]
                            );
                        }
                        subInput.setAttribute("name", subParameters[iSubParam]);
                        subInputWrapper.appendChild(subInput);

                        row.appendChild(subInputWrapper);
                        entriesWrapper.appendChild(row);
                    }

                    let deleteBtn = document.createElement("a");
                    deleteBtn.setAttribute(
                        "class",
                        "subform-buttons delete-btn"
                    );
                    idName == "User Input" && isLocked == true
                        ? (deleteBtn.style.pointerEvents = "none")
                        : (deleteBtn.style.pointerEvents = "auto");
                    deleteBtn.addEventListener("click", function (evt) {
                        let element = evt.target.parentNode;
                        element.remove();
                    });

                    row.appendChild(deleteBtn);
                }

                input.appendChild(entriesWrapper);

                addEntry.addEventListener("click", function (evt) {
                    var newRow = document.createElement("div");
                    newRow.setAttribute("class", "subInputRow");
                    for (let parameter of subParameters) {
                        let subInputWrapper = document.createElement("div");
                        subInputWrapper.setAttribute("class", "subInput-field");

                        let subInputLabel = document.createElement("label");
                        subInputLabel.setAttribute("class", "label-style");

                        subInputLabel.textContent = parameter;

                        subInputWrapper.appendChild(subInputLabel);

                        let subInput = document.createElement("input");

                        subInput.setAttribute("name", parameter);
                        if (idName == "User Input") {
                            subInput.style.fontWeight = "700";
                            parameter == "attribute" && isLocked == true
                                ? (subInput.readOnly = true)
                                : null;
                        }
                        subInputWrapper.appendChild(subInput);
                        newRow.appendChild(subInputWrapper);
                    }

                    let deleteBtn = document.createElement("a");
                    deleteBtn.setAttribute(
                        "class",
                        "subform-buttons delete-btn"
                    );

                    if (idName == "User Input") {
                        isLocked == true
                            ? (deleteBtn.style.pointerEvents = "none")
                            : (deleteBtn.style.pointerEvents = "auto");
                    }
                    deleteBtn.addEventListener("click", function (evt) {
                        let row = evt.target.parentNode;
                        row.remove();
                    });

                    newRow.appendChild(deleteBtn);

                    entriesWrapper.appendChild(newRow);
                });

                if ("help" in templateValue) {
                    input.setAttribute("title", templateValue["help"]);
                }

                commonRender = false;
            } //Fim do subform
            else if (
                "multiselect" in templateValue ||
                "textlist" in templateValue
            ) {
                generateCustomGrid = true;
                elementList.style.width = "calc(100% - 43.4px)";
                var selectType =
                    "multiselect" in templateValue ? "multiselect" : "textlist";
                var subOptions;
                if (selectType == "multiselect") {
                    subOptions = templateValue[selectType];
                } else {
                    subOptions =
                        newComp == true ? templateValue[selectType] : value;
                }
                var input = document.createElement("select");
                input.setAttribute("name", parameter);
                input.setAttribute("class", "input-field");
                input.setAttribute("multiple", "multiple");
                input.setAttribute("style", "height: max-content;");
                input.setAttribute(
                    "id",
                    idName + "-xx-" + divIdIndex + "-xx-" + parameter
                );

                if ("help" in templateValue) {
                    input.setAttribute("title", templateValue["help"]);
                }
                if (selectType == "textlist") {
                    if (typeof subOptions == "string") {
                        var tempSubOptions = subOptions.split(",");
                        subOptions = tempSubOptions.map((element) => {
                            return element;
                        });
                    }
                }
                if (subOptions.length > 0) {
                    for (var subOption of subOptions) {
                        if (subOption !== "") {
                            var option = document.createElement("option");
                            option.value = subOption;
                            option.textContent = subOption;

                            if (newComp == true) {
                                option.setAttribute("selected", "selected");
                            } else {
                                if (value.includes(subOption)) {
                                    option.setAttribute("selected", "selected");
                                }
                            }
                            input.appendChild(option);
                        }
                    }
                }

                commonRender = false;
            } else if ("nn_schema" in templateValue) {
                var input = document.createElement("input");
                idName_ = idName.replace(/\s/g, "");
                input.setAttribute(
                    "id",
                    "nn_schema_" +
                        idName_ +
                        "-xx-" +
                        divIdIndex +
                        "-xx-" +
                        idCanvas.split("-xx-")[1]
                );
                if (newComp == true) {
                    valueToRender = value["nn_schema"];
                } else {
                    valueToRender = value;
                }
                input.setAttribute("value", valueToRender);
                input.setAttribute("name", parameter); //name recebe o nome do parametro (assim como label)

                input.style = "visibility: hidden";
                //input.setAttribute("size", "50");
                inputButton = renderOpenNNMenuButton(
                    idName,
                    divIdIndex,
                    idCanvas
                );
                elementList.appendChild(inputButton);
                commonRender = false;
            }
        } //Fim da verficação se tem tipo objeto no parametro

        if (commonRender == true) {
            var input = document.createElement("input");

            if (parameter == "password") {
                input.setAttribute("type", "password");
                input.setAttribute("autocomplete", "new-password");
            } else {
                input.setAttribute("type", "text");
            }
            input.setAttribute(
                "value",
                JSON.stringify(value).replace(/"/g, "")
            );
            input.setAttribute("name", parameter); //name recebe o nome do parametro (assim como label)

            input.setAttribute("size", "50");
        }

        if (parameter == "id_name") {
            input.setAttribute("disabled", "true");
        }
        if (parameter == "name") {
            input.setAttribute("id", "name_" + value + divIdIndex);
        }

        if (elementList.appendChild(input)) {
            if (input.nodeName == "SELECT" && input.multiple == true) {
                let brackId = "[id='" + input.id + "']";
                const tags = "multiselect" in templateValue ? false : true;

                setTimeout(function () {
                    $(brackId).select2({
                        width: "unset",
                        tags: tags,
                    }),
                        1;

                    $("ul.select2-selection__rendered").sortable({});
                    $(brackId).on("select2:opening", function () {
                        componentParameters = _.isEmpty(componentParameters)
                            ? componentsTemplates[idName]
                            : componentParameters;
                        let idComp = idName + "-xx-" + divIdIndex;
                        let componentParametersStr =
                            JSON.stringify(componentParameters);
                        if (idName != "Deep Neural Network") {
                            Object.keys(
                                JSON.parse(
                                    componentParametersStr.replace(/\n/g, "\\n")
                                )
                            ).length === 0
                                ? (componentParameters =
                                      componentsTemplates[idName])
                                : null;

                            const componentParametersJson =
                                typeof componentParametersStr == "string"
                                    ? JSON.parse(
                                          componentParametersStr.replace(
                                              /\n/g,
                                              "\\n"
                                          )
                                      )
                                    : componentParametersStr;

                            const keys = Object.keys(componentParametersJson);
                            for (var key of keys) {
                                if (
                                    componentsTemplates[idName][key] &&
                                    componentsTemplates[idName][key]
                                        .show_attributes == true
                                ) {
                                    let selectId = idComp + "-xx-" + key;
                                    for (var header of headersList) {
                                        let newOption = new Option(
                                            header,
                                            header
                                        );
                                        const parent =
                                            document.getElementById(selectId);
                                        if (!header.includes("=")) {
                                            if (
                                                parent.querySelectorAll(
                                                    "option[value='" +
                                                        header +
                                                        "']"
                                                ).length == 0
                                            ) {
                                                select = $(
                                                    "[id='" + selectId + "']"
                                                )
                                                    .append(newOption)
                                                    .trigger("changed");
                                            }
                                        }
                                    }
                                }
                            }
                        }
                    });
                    try {
                        let select =
                            $(brackId).siblings()[1].childNodes[0]
                                .childNodes[0];
                        select.classList.add("form-multiselect");
                    } catch (e) {}
                });
            }
        }

        listParameters.appendChild(elementList);

        "grid_config" in componentTemplate
            ? (elementList.style.gridArea = parameter)
            : null;

        if (idName) {
            try {
                if ("select" in templateValue || "text" in templateValue) {
                    if (parameter) {
                        let subString =
                            '"' + parameter + " " + parameter + " " + '"';
                        if (
                            componentTemplate["grid_config"]
                                .replace(/ /g, "")
                                .includes(subString.replace(/ /g, ""))
                        ) {
                            elementList.style.width = "calc(100% - 43.4px)";
                        }
                    }
                }
            } catch (e) {}
        }

        nFormEntries = nFormEntries + 1;
    }
    if ("grid_config" in componentTemplate) {
        listParameters.style.gridTemplateAreas =
            componentTemplate["grid_config"];
        listParameters.style.gridTemplateColumns = "unset";
    }

    form.appendChild(listParameters);
    extraSize = 0;
    if (nFormEntries <= 4) {
        extraSize = 45;
        if (commonRender == false) {
            if ("textarea" in templateValue) {
                extraSize = 175;
            }
        }
    }
    document.getElementById(
        "menu_" + idName + "-xx-" + divIdIndex
    ).style.width = "100%";

    return form;
}

/*
Função que gera um schema novo (apenas quando é nova aplicação)
*/
function newSchema() {
    count = 0; //reinicia contagem
    createSchema("schema_1"); //Função que vêm do controle de schemas
}

/*
Função que deleta os schemas correntes
*/

const gptObj = {
    components: {
        "Load Data Objects": {
            component_type: "input",
            dataset: "exemplo",
            dataset_learning: "",
            id_name: "Load Data Objects",
            name: "",
            query: "",
        },
        "Print Data": {
            component_type: "",
            id_name: "Print Data",
            limit_data: "10",
            name: "",
            print_data_schema: true,
            sort_attributes: "",
            sort_conditions: "",
        },
    },
    connections: [
        {
            sourceComp: "Load Data Objects",
            targetComp: "Print Data",
        },
    ],
};

function resetSchemas(schemas) {
    nSchemas = Object.keys(schemas).length;
    schemasNames = Object.keys(schemas);
    for (var iSchema = 0; iSchema < nSchemas; iSchema++) {
        name = schemasNames[iSchema];
        schemaName = name in schemasAliases ? schemasAliases[name] : name;
        resetSchema(schemaName); //Função que vêm do controle de schemas
    }
}

//Função que irá gerar componentes e connections baseado no output do prompt
function handlePromptSchema(data, appSchema, componentId, left, top) {
    var compAliases = {};
    const components = Object.keys(data["components"]);
    const connections = data["connections"];
    schemas = getSchemas();

    let positionIncrementor = 150;
    for (let comp of components) {
        count++;
        let divId = comp + "-xx-" + count;
        compAliases[comp] = divId;
        const componentData = {
            div_id: divId,
            parameters: data["components"][comp],
            position_left: Number(left) + positionIncrementor,
            position_top: Number(top),
        };
        componentData.parameters.name = comp + " " + count;
        createLoadedComponent(componentData, appSchema, false);
        positionIncrementor += 150;
    }
    if (componentId && componentId !== "undefined") {
        let idName = componentId.split("-xx-")[0];
        compAliases[idName] = componentId;
    }
    //Connections
    j = jsInstances[appSchema];

    for (let con of connections) {
        let divIdSource = compAliases[con["sourceComp"]];
        let divIdTarget = compAliases[con["targetComp"]];
        let source = divIdSource + "_0";
        let target = divIdTarget + "_1";
        let connection = j.connect({ uuids: [source, target] });
    }
    updateSchemas();
}

/*
Função que gera schemas, componentes e ligações a partir do JSON de entrada,
assim que uma aplicação é lida
*/
function generateSchemas(schemas, schemasAliases) {
    count = 0; //reinicia contagem
    schemasNames = Object.keys(schemas);
    nSchemas = schemasNames.length;
    /*
  schemasNames = [];
  for (var iSchema = 1; iSchema<=nSchemas; iSchema++){
    schemasNames.push("schema_" + iSchema.toString())
  }
  */

    /*
  Gera-se a quantidade de schemas existentes
  */
    //>>>>> OBS: Chamada função que compõe a parte do Guilherme
    for (var iSchema = 0; iSchema < nSchemas; iSchema++) {
        //OBS: Criação de schemas é através dos nomes originais: schema_1, schema_2,...
        createSchema(schemasNames[iSchema]);
        //Inicializa contador de menus abertos por schemas
        menusOpenedSchemas[schemasNames[iSchema]] = 0;
        /*if (Object.keys(schemasAliases).length > 0){
      schemaName = schemasAliases[schemasNames[iSchema]];
    }
    else{*/
        schemaName = schemasNames[iSchema];
        componentsInSchema = schemas[schemaName]["components"];
        var stickersInSchema;

        if (schemas[schemaName]["stickers"]) {
            stickersInSchema = schemas[schemaName]["stickers"];
            nStickersInSchema = stickersInSchema.length;
            for (var iSticker = 0; iSticker < nStickersInSchema; iSticker++) {
                try {
                    createLoadedSticker(
                        stickersInSchema[iSticker],
                        schemasNames[iSchema]
                    );
                } catch (e) {
                    console.log(e);
                    continue;
                }
            }
        }

        nCompInSchema = componentsInSchema.length;

        //Gerar cada componente

        for (var iComp = 0; iComp < nCompInSchema; iComp++) {
            try {
                createLoadedComponent(
                    componentsInSchema[iComp],
                    schemasNames[iSchema]
                );
            } catch (e) {
                continue;
            }
        }

        //Renderiza as conexões
        connectionsInSchema = schemas[schemaName]["connections"];
        nConnections = connectionsInSchema.length;
        /*
    https://stackoverflow.com/questions/37419562/jsplumb-choose-which-endpoint-to-connect-to-if-an-element-has-multiple-endpoints
    https://stackoverflow.com/questions/22244492/jsplumb-connect-use-existing-endpoints-instead-of-creating-new
    */
        j = jsInstances[schemasNames[iSchema]];
        for (var iConn = 0; iConn < nConnections; iConn++) {
            if (
                document.getElementById(
                    connectionsInSchema[iConn]["source_id"]
                ) == null
            ) {
                var divIdNumber =
                    connectionsInSchema[iConn]["source_id"].split("-xx-")[1];
                var newIdName =
                    componentsAliases[
                        connectionsInSchema[iConn]["source_id"].split("-xx-")[0]
                    ];
                connectionsInSchema[iConn]["source_id"] =
                    newIdName + "-xx-" + divIdNumber;
            }

            if (
                document.getElementById(
                    connectionsInSchema[iConn]["target_id"]
                ) == null
            ) {
                var divIdNumber =
                    connectionsInSchema[iConn]["target_id"].split("-xx-")[1];
                var newIdName =
                    componentsAliases[
                        connectionsInSchema[iConn]["target_id"].split("-xx-")[0]
                    ];
                connectionsInSchema[iConn]["target_id"] =
                    newIdName + "-xx-" + divIdNumber;
            }

            source = connectionsInSchema[iConn]["source_id"] + "_0";
            target = connectionsInSchema[iConn]["target_id"] + "_1";
            j.connect({ uuids: [source, target] });
        }
    } //fim do for de schemas

    //Ajusta valor de count baseado nos div_ids existentes
    maxValue = 0;
    schemasNames = Object.keys(schemas);
    nSchemas = schemasNames.length;
    for (iSchema = 0; iSchema < nSchemas; iSchema++) {
        schemaN = schemasNames[iSchema];
        nComp = schemas[schemaN]["components"].length;
        for (iComp = 0; iComp < nComp; iComp++) {
            component = schemas[schemaN]["components"][iComp];
            value = parseInt(component["div_id"].split("-xx-")[1]);
            if (value > maxValue) {
                maxValue = value;
            }
        }
    }
    count = maxValue;

    //Ajusta valor de count baseado nos div_ids dos stickers existentes
    if (schemas[schemaN]["stickers"]) {
        maxStickerValue = 0;
        for (var iSchema = 0; iSchema < nSchemas; iSchema++) {
            schemaN = schemasNames[iSchema];
            nSticker = schemas[schemaN]["stickers"].length;
            for (iSticker = 0; iSticker < nSticker; iSticker++) {
                sticker = schemas[schemaN]["stickers"][iSticker];
                stickerValue = parseInt(
                    sticker["sticker_div_id"].split("-xx-")[1]
                );
                if (stickerValue > maxStickerValue) {
                    maxStickerValue = stickerValue;
                }
            }
        }
        stickerCount = maxStickerValue;
    }

    if (needToSaveApp == true) {
        setTimeout(function () {
            saveApplication(schemaName, false);
        }, 200);
    }
    needToSaveApp = false; //reset de variavel
}

/*
Faz o tratamento quando um componente é selecionado
*/
function selectComponent(evt, idComp, appSchema) {
    jsInstances[appSchema] != null
        ? (jsInstance = jsInstances[appSchema])
        : (jsInstance = jsInstances[schemasAliases[appSchema]]);

    //Forçando foco no schema do componente
    document.getElementById(appSchema) != null
        ? document.getElementById(appSchema).focus()
        : document.getElementById(schemasAliases[appSchema]).focus();

    if (evt.ctrlKey) {
        var $componentElem = $(document.getElementById(idComp));
        if (selectedComponents.includes(idComp)) {
            $componentElem.css("outline-style", "none");
            jsInstance.removeFromDragSelection($componentElem);
            selectedComponents.splice(selectedComponents.indexOf(idComp), 1);
        } else {
            $componentElem.css("outline-style", "dashed");
            $componentElem.css("outline-color", "black");
            $componentElem.css("outline-radius", "9px");
            $componentElem.css("outline-width", "1px");
            jsInstance.addToDragSelection($componentElem);
            selectedComponents.push(idComp);
        }
    } else {
        //jsInstance.clearDragSelection();
        for (i = 0; i < selectedComponents.length; i++) {
            var $componentElem = $(
                document.getElementById(selectedComponents[i])
            );
            $componentElem.css("outline-style", "none");
            jsInstance.removeFromDragSelection($componentElem);
            compRemoveElement = document.getElementById(
                "remove_component_div_" + selectedComponents[i]
            );
            helpElement = document.getElementById(
                "help_icon_component_div_" + selectedComponents[i]
            );
            if (compRemoveElement != null) {
                compRemoveElement.style.visibility = "hidden";
                helpElement.style.visibility = "hidden";
            }
        }
        selectedComponents = [];
        var $componentElem = $(document.getElementById(idComp));
        $componentElem.css("outline-style", "dashed");
        $componentElem.css("outline-color", "black");
        $componentElem.css("outline-radius", "7px");
        $componentElem.css("outline-width", "1px");
        jsInstance.addToDragSelection($componentElem);
        selectedComponents.push(idComp);
        compRemoveElement = document.getElementById(
            "remove_component_div_" + idComp
        );
        helpElement = document.getElementById(
            "help_icon_component_div_" + idComp
        );
        compRemoveElement.style.visibility = "visible";
        helpElement.style.visibility = "visible";
    }
} //Fim da função selectComponent

/*
Apaga todos os componentes selecionados
*/

function removeComponents(appSchema, isUndoRedo, divIds) {
    appSchema = schemasAliases[appSchema]
        ? schemasAliases[appSchema]
        : appSchema;
    schemas = getSchemas();

    var undoRedoJson = [];
    if (isUndoRedo == true) {
        selectedComponents = divIds;
        schemas[appSchema] == undefined
            ? (appSchema = schemasAliases[appSchema])
            : null;
    }

    selectedComponents.length > 1 ? (isMultiple = true) : (isMultiple = false);

    for (i = 0; i < selectedComponents.length; i++) {
        menuId = "wrapper_menu_" + selectedComponents[i];
        for (var c in schemas[appSchema]["components"]) {
            if (
                schemas[appSchema]["components"][c]["div_id"] ==
                selectedComponents[i]
            ) {
                var component = {};
                component["connections"] = [];
                for (var con in schemas[appSchema]["connections"]) {
                    if (
                        schemas[appSchema]["connections"][con]["source_id"] ==
                            selectedComponents[i] ||
                        schemas[appSchema]["connections"][con]["target_id"] ==
                            selectedComponents[i]
                    ) {
                        component["connections"].push(
                            schemas[appSchema]["connections"][con]
                        );
                    }
                }
                component["component_info"] =
                    schemas[appSchema]["components"][c];
                undoRedoJson.push(component);
            }
        }
        removeComponent(
            menuId,
            selectedComponents[i],
            appSchema,
            null,
            isMultiple
        );
    }

    undoRedoJson["schema"] = appSchema;
    if (isCut == true) {
        var info = {
            cutComponents: undoRedoJson,
        };
        if (undoCommands.length == 5) undoCommands.pop();

        undoCommands.unshift(info);
    } else if (selectedComponents.length > 1) {
        var info = {
            removeMultipleComponents: undoRedoJson,
        };
        if (undoCommands.length == 5) undoCommands.pop();

        undoCommands.unshift(info);
    }
}

/*
Seleciona todos os componentes
*/
function selectAllComponents(appSchema, evt) {
    var appSchema_ = appSchema; //Salvar o nome antigo, caso necessário

    appSchema = schemasAliases[appSchema]
        ? schemasAliases[appSchema]
        : appSchema;
    clearComponentsSelection(); //Limpa selecionados anteriormente para evitar duplicata

    var blockSelectAll = false;
    schemas = getSchemas();

    jsInstance = jsInstances[appSchema_];
    componentsInSchema = schemas[appSchema]["components"];
    stickersInSchema = schemas[appSchema]["stickers"];

    for (var j = 0; j < componentsInSchema.length; j++) {
        var menuId = "wrapper_menu_" + componentsInSchema[j]["div_id"];
        if (document.getElementById(menuId)) {
            if (document.getElementById(menuId).style.display == "block") {
                blockSelectAll = true;
            }
        }
    }

    for (var sticker in stickersInSchema) {
        var idCount =
            stickersInSchema[sticker]["sticker_div_id"].split("-xx-")[1];
        var stickerDiv = document.getElementById(
            "sticker-content-xx-" + idCount
        );
        if ($("#" + stickerDiv.id).is(":focus")) blockSelectAll = true;
    }

    if (blockSelectAll == false) {
        evt.preventDefault(); //Evitando propagação do CTRL + A na tela inteira
        for (i = 0; i < componentsInSchema.length; i++) {
            var $componentElem = $(
                document.getElementById(componentsInSchema[i]["div_id"])
            );
            $componentElem.css("outline-style", "dashed");
            $componentElem.css("outline-color", "black");
            $componentElem.css("outline-radius", "7px");
            $componentElem.css("outline-width", "1px");
            jsInstance.addToDragSelection($componentElem);
            selectedComponents.push(componentsInSchema[i]["div_id"]);
        }
    }
}

/*
Retira a seleção de todos os componentes selecionados atuais.
Esta função é utilizada quando se clica em elementos que fazem
tirar o foco de componentes selecionados: (1) janelas de parametros
(2) Canvas
*/
function clearComponentsSelection() {
    for (i = 0; i < selectedComponents.length; i++) {
        var $componentElem = $(document.getElementById(selectedComponents[i]));
        $componentElem.css("outline-style", "none");
        jsInstance.removeFromDragSelection($componentElem);
        compRemoveElement = document.getElementById(
            "remove_component_div_" + selectedComponents[i]
        );
        helpWindowElement = document.getElementById(
            "help_icon_component_div_" + selectedComponents[i]
        );
        if (compRemoveElement != null) {
            compRemoveElement.style.visibility = "hidden";
            helpWindowElement.style.visibility = "hidden";
        }
    }
    selectedComponents = [];
}

/*
Cola componentes copiados
*/

function pasteComponents(appSchema, isRedo, redoJson) {
    schemas = getSchemas();

    appSchema_ = appSchema;
    appSchema = schemasAliases[appSchema]
        ? schemasAliases[appSchema]
        : appSchema;

    if (schemas[sourceSchemaWhenCopy] == undefined) {
        sourceSchemaWhenCopy = schemasAliases[sourceSchemaWhenCopy]
            ? schemasAliases[sourceSchemaWhenCopy]
            : sourceSchemaWhenCopy;
    }

    var undoRedoJson = {};
    undoRedoJson["components"] = [];
    undoRedoJson["connections"] = [];
    jsInstance = jsInstances[appSchema_];

    componentsInOriginalSchema = schemas[sourceSchemaWhenCopy]["components"];

    selectedComponentsNew = [];
    aliasDiv = {};

    if (isRedo == true) {
        selectedComponentsToCopy = redoJson["div_ids"];
        componentsInOriginalSchema = redoJson["json"];
    }

    for (iComp = 0; iComp < componentsInOriginalSchema.length; iComp++) {
        if (
            selectedComponentsToCopy.includes(
                componentsInOriginalSchema[iComp]["div_id"]
            )
        ) {
            count++;
            originalDivId = componentsInOriginalSchema[iComp]["div_id"];
            componentsInOriginalSchema[iComp]["div_id"] =
                componentsInOriginalSchema[iComp]["div_id"].split("-xx-")[0] +
                "-xx-" +
                count.toString();

            if (appSchema != sourceSchemaWhenCopy || isRedo == true) {
                positionLeftIncrement = 0; //Removendo deslocamento se for em outro esquema
            }

            undoRedoJson["components"].push(componentsInOriginalSchema[iComp]);
            createLoadedComponent(
                componentsInOriginalSchema[iComp],
                appSchema_,
                true
            );

            aliasDiv[originalDivId] =
                componentsInOriginalSchema[iComp]["div_id"];
            //Adicionar aos componentes selecionados
            selectedComponentsNew.push(
                componentsInOriginalSchema[iComp]["div_id"]
            );
            isCut == false ? updateSchemas() : null;
        }
    }
    //Remover os selecionados anteriormente
    for (i = 0; i < selectedComponents.length; i++) {
        var $componentElem = $(document.getElementById(selectedComponents[i]));
        $componentElem.css("outline-style", "none");
        jsInstance.removeFromDragSelection($componentElem);
        compRemoveElement = document.getElementById(
            "remove_component_div_" + selectedComponents[i]
        );
        if (compRemoveElement != null) {
            compRemoveElement.style.visibility = "hidden";
        }

        helpIconElement = document.getElementById(
            "help_icon_component_div_" + selectedComponents[i]
        );
        if (helpIconElement != null) {
            helpIconElement.style.visibility = "hidden";
        }
    }
    //Adicionar os novos selecionados (componentes recém gerados)

    for (i = 0; i < selectedComponentsNew.length; i++) {
        var $componentElem = $(
            document.getElementById(selectedComponentsNew[i])
        );
        $componentElem.css("outline-style", "dashed");
        $componentElem.css("outline-color", "black");
        $componentElem.css("outline-radius", "7px");
        $componentElem.css("outline-width", "1px");
        jsInstance.addToDragSelection($componentElem);
    }
    //Por fim, atribui os novos componentes adicionados como selecionados
    selectedComponents = selectedComponentsNew;

    //Renderiza as conexões dos elementos
    isRedo == true
        ? (connectionsInSchema = redoJson["connections"])
        : (connectionsInSchema = schemas[sourceSchemaWhenCopy]["connections"]);
    // console.log(connectionsInSchema);

    nConnections = connectionsInSchema.length;
    /*
  https://stackoverflow.com/questions/37419562/jsplumb-choose-which-endpoint-to-connect-to-if-an-element-has-multiple-endpoints
  https://stackoverflow.com/questions/22244492/jsplumb-connect-use-existing-endpoints-instead-of-creating-new
  */

    j = jsInstances[appSchema_];

    for (var iConn = 0; iConn < nConnections; iConn++) {
        newDivIdSource = aliasDiv[connectionsInSchema[iConn]["source_id"]];
        newDivIdTarget = aliasDiv[connectionsInSchema[iConn]["target_id"]];
        if (newDivIdSource != undefined && newDivIdTarget != undefined) {
            source = newDivIdSource + "_0";
            target = newDivIdTarget + "_1";
            connection = j.connect({ uuids: [source, target] });
            connectionsInSchema[iConn]["source_id"] = newDivIdSource;
            connectionsInSchema[iConn]["target_id"] = newDivIdTarget;

            undoRedoJson["connections"].push(connectionsInSchema[iConn]);
        }
    }
    isCut == true ? updateSchemas() : null;

    var oldJson = JSON.parse(JSON.stringify(componentsInOriginalSchema));

    undoRedoJson["oldJson"] = oldJson;
    undoRedoJson["schema"] = appSchema;
    var info = {
        pasteComponents: undoRedoJson,
    };

    if (undoCommands.length == 5) undoCommands.pop();

    undoCommands.unshift(info);
}

/*
Operação de cópia dos componentes
*/
function copyComponents(appSchema) {
    positionLeftIncrement = 30; //Resetando o valor para posição inicial quando copia outro componet
    updateSchemas(); //Atualiza esquema para garantir consistência
    selectedComponentsToCopy = selectedComponents;
    sourceSchemaWhenCopy = appSchema;
}

/*
Função que renderiza texto de ajuda
*/

function createHelpText(componentTemplate, idName, divIdIndex) {
    allText = "";
    allText = allText + componentTemplate["help"] + "\n\n";
    allText = allText + "Parameters:" + "\n\n";
    for (var parameter in componentTemplate) {
        if (
            parameter != "help" &&
            parameter != "component_type" &&
            parameter != "help" &&
            parameter != "name" &&
            parameter != "id_name" &&
            parameter != "input_dim" &&
            parameter != "help_link"
        ) {
            paramText =
                "-" +
                parameter +
                ": " +
                componentTemplate[parameter]["help"] +
                "\n";
            allText = allText + paramText;
        }
    }

    //divOutHelp = document.createElement("div");
    //divOutHelp.setAttribute("id", "out_textarea_help_" + idName + "-xx-" + divIdIndex);
    //divOutHelp.setAttribute("style", "width: 600px; height: 450px; position: absolute; overflow-x: hidden; overflow-y: auto; left: 10px; top: 0px")

    helpLink = componentTemplate["help_link"];

    headerHelp = document.createElement("label");
    headerHelp.setAttribute(
        "id",
        "header_help_" + idName + "-xx-" + divIdIndex
    );
    headerHelp.setAttribute(
        "style",
        "color: white; font-size:20px; width: 585px; height: 30px; position: absolute; overflow: hidden; left: 10px; top: 10px"
    );
    headerHelp.innerHTML = componentTemplate["id_name"];

    linkHelp = document.createElement("a");
    linkHelp.setAttribute(
        "id",
        "linkhelp_help_" + idName + "-xx-" + divIdIndex
    );
    linkHelp.setAttribute(
        "style",
        "color: white; font-size:15px; height: 30px; position: absolute; overflow: hidden; left: 32px; top: 50px"
    );
    linkHelp.setAttribute("href", helpLink);
    linkHelp.setAttribute("target", "_blank");
    linkHelp.innerHTML = "More information";

    textAreaHelp = document.createElement("label");
    textAreaHelp.setAttribute(
        "id",
        "textarea_help_" + idName + "-xx-" + divIdIndex
    );
    textAreaHelp.setAttribute(
        "style",
        "width: 585px; height: 370px; overflow: auto; position: absolute; white-space: pre-wrap; color:white; font-size:15px; left: 10px; top: 80px"
    );
    textAreaHelp.innerHTML = allText;

    helpWindow = document.getElementById(
        "helpwindow_" + idName + "-xx-" + divIdIndex
    );

    helpWindow.appendChild(headerHelp);
    helpWindow.appendChild(linkHelp);
    helpWindow.appendChild(textAreaHelp);
    //divOutHelp.appendChild(headerHelp)
    //divOutHelp.appendChild(linkHelp)
    //divOutHelp.appendChild(textAreaHelp)
    //return [headerHelp, linkHelp, textAreaHelp]
}

/*
Cria um componente de um aplicação salva e contida nos JSONs
*/
var positionLeftIncrement = 30; //Variável para modificar colar o componente ao lado do outro
function createLoadedComponent(componentData, appSchema, isCopy) {
    var parametersIconUrl = "";
    schemas = getSchemas();

    if (isCopy) {
        componentData["position_left"] =
            componentData["position_left"] + positionLeftIncrement;
        positionLeftIncrement = positionLeftIncrement + 50;

        if (appSchema == sourceSchemaWhenCopy) {
            var compCount = 0;
            var components = schemas[appSchema]["components"];
            for (var iComp = 0; iComp < components.length; iComp++) {
                var idComp = componentData["div_id"].split("-xx-")[0];
                if (idComp == components[iComp]["parameters"]["id_name"]) {
                    compCount++;
                }
            }

            if (!componentData["parameters"]["name"].includes("-copy")) {
                componentData["parameters"]["name"] =
                    componentData["parameters"]["name"] +
                    " -copy " +
                    "(" +
                    compCount +
                    ")";
            } else {
                var splitted =
                    componentData["parameters"]["name"].split("-copy")[0];
                componentData["parameters"]["name"] =
                    splitted + "-copy " + "(" + compCount + ")";
            }
        }
    }

    count++;
    if (componentsAliases[componentData["parameters"]["id_name"]]) {
        needToSaveApp = true;
    }
    componentData["parameters"]["id_name"] = componentsTemplates[
        componentData["parameters"]["id_name"]
    ]
        ? componentData["parameters"]["id_name"]
        : componentsAliases[componentData["parameters"]["id_name"]];

    idName = componentData["parameters"]["id_name"];

    if (!componentData["div_id"].includes(idName)) {
        var divIdNumber = componentData["div_id"].split("-xx-")[1];
        componentData["div_id"] = idName + "-xx-" + divIdNumber;
    }

    idName = componentData["parameters"]["id_name"];

    styleComp = {};

    if (componentData["div_id"].includes("-!@-")) {
        var divIdIndex = componentData["div_id"].split("-!@-")[1];
    } else {
        var divIdIndex = componentData["div_id"].split("-xx-")[1];
    }

    componentParameters = componentData["parameters"];

    componentsTemplates = getComponentsTemplates(); //Pegando JSON lido

    //Template do componente atual
    componentTemplate = componentsTemplates[idName];

    //nativeComponents é variável de applicationsControl
    if (nativeComponents.includes(idName)) {
        parametersIconUrl = componentsIconsType[componentTemplate["icon_type"]];

        styleComp = styleCompNative;
    } else {
        parametersIconUrl =
            "../../static/icons/components_types/custom_components.svg";
        styleComp = styleCompCustom;
    }

    /*
  Criando DIV principal do componente
  */
    var box;
    if (document.getElementById("box_item_" + appSchema) != undefined) {
        box = document.getElementById("box_item_" + appSchema);
        j = jsInstances[appSchema];
    } else {
        box = document.getElementById("box_item_" + schemasAliases[appSchema]);
        j = jsInstances[schemasAliases[appSchema]];
    }

    var conteudo = box.innerHTML;
    var div = document.createElement("div");
    //Armazenar do componente: name, id_name, e div id
    div.setAttribute("class", "item");
    if ("help" in componentTemplate) {
        div.setAttribute("title", componentTemplate["help"]);
    } else {
        div.setAttribute("title", idName);
    }
    div.setAttribute("id", idName + "-xx-" + divIdIndex);
    //div.setAttribute("style", "font-size:11px; width: 70px; height: 70px; padding: 0%; position: absolute; background-color:" + styleComp["color"] + "; float: left; color: white; text-align: center; border-radius: 7px; left:" + componentData["position_left"].toString() + "px ; top:" + componentData["position_top"].toString() + "px;");
    div.setAttribute(
        "style",
        "font-size:11px; width: 70px; height: 70px; padding: 0%; position: absolute; background: linear-gradient(" +
            styleComp["color-grad"] +
            "," +
            styleComp["color"] +
            "); float: left; color: white; text-align: center; border-radius: 7px; left:" +
            componentData["position_left"].toString() +
            "px ; top:" +
            componentData["position_top"].toString() +
            "px;"
    );
    div.setAttribute(
        "onmousedown",
        "selectComponent(event,'" + div.id + "' ,'" + appSchema + "');"
    );

    /*
  Criando menu de parâmetros (DIV)
  */

    var parametersWindowWrapper = document.createElement("div");
    parametersWindowWrapper.setAttribute("class", "parametersMenu");
    parametersWindowWrapper.style.zIndex = "100";
    parametersWindowWrapper.setAttribute(
        "id",
        "wrapper_menu_" + idName + "-xx-" + divIdIndex
    );
    divinside = document.createElement("div");

    var pinIcon = document.createElement("a");
    pinIcon.setAttribute(
        "style",
        "background-repeat: no-repeat; width: 25px; z-index: 10; height: 25px; display: block; position: absolute; top: 5px; left: 5px; cursor: pointer;"
    );

    //Renderizando janelas fixadas
    let isFixed = false;
    let correctSchemaName = schemas[schemasAliases[schemaName]]
        ? schemasAliases[schemaName]
        : schemaName;

    if (schemas[correctSchemaName]["fixed_windows"]) {
        for (var window of schemas[correctSchemaName]["fixed_windows"]) {
            if (window.div_id == parametersWindowWrapper.id) {
                isFixed = true;
                parametersWindowWrapper.style.display = "block";
                parametersWindowWrapper.style.left = window.position_left;
                parametersWindowWrapper.style.top = window.position_top;
            }
        }
    }
    pinIcon.style.backgroundImage = isFixed
        ? "url('../../static/icons/pin_window_completed_icon.svg')"
        : "url('../../static/icons/pin_window_icon.svg')";

    isFixed == true
        ? $(parametersWindowWrapper).draggable({ disabled: true })
        : $(parametersWindowWrapper).draggable(generateDragConfig(box));

    pinIcon.addEventListener("click", function () {
        isFixed = !isFixed;
        if (isFixed == true) {
            $parentElement = this.parentElement;
            $(this.parentElement).draggable({
                disabled: true,
            });
            pinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_completed_icon.svg')";
        } else {
            $(this.parentElement).draggable(generateDragConfig(box));
            pinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_icon.svg')";
        }
    });
    parametersWindowWrapper.appendChild(pinIcon);

    var menuCloseButton = document.createElement("span");
    menuCloseButton.setAttribute(
        "id",
        "menu_close_" + idName + "-xx-" + divIdIndex
    );
    menuCloseButton.setAttribute(
        "onclick",
        "closeComponentMenu('" + parametersWindowWrapper.id + "');"
    );
    menuCloseButton.setAttribute("class", "close-messagebar");
    menuCloseButton.title = "Close and keep parameters";
    parametersWindowWrapper.appendChild(menuCloseButton);

    divinside.setAttribute("id", "menu_" + idName + "-xx-" + divIdIndex);
    divinside.addEventListener("click", function (event) {
        panzoomInstances[appSchema].pause();
        event.stopPropagation();
    });

    divinside.setAttribute("onmousedown", "clearComponentsSelection()");
    parametersWindowWrapper.appendChild(divinside);
    parametersWindowWrapper.addEventListener("mousedown", function () {
        panzoomInstances[appSchema].pause();

        setFocus("false", this.id);
    });
    box.appendChild(parametersWindowWrapper);
    box.appendChild(div);

    $("[id='" + parametersWindowWrapper.id + "']").draggable({
        containment: "parent",
    });
    // Criar janela de print para componente
    var componentlogWindow = document.createElement("div");

    componentlogWindow.setAttribute(
        "id",
        "log_" + idName + "-xx-" + divIdIndex
    );

    componentlogWindow.setAttribute(
        "style",
        "min-width: 400px; width: max-content; max-width: 1400px; height: 400px; max-height: 600px;  display: none; border: 1px solid #cccccc; border-radius: 12px; position: absolute; z-index: 100; background-color: black; overflow: visible;  animation: 5s;"
    );

    //Renderizando janelas fixadas
    isFixed = false;
    if (schemas[correctSchemaName]["fixed_windows"]) {
        for (var window of schemas[correctSchemaName]["fixed_windows"]) {
            if (window.div_id == componentlogWindow.id) {
                isFixed = true;
                componentlogWindow.style.display = "block";
                componentlogWindow.style.left = window.position_left;
                componentlogWindow.style.top = window.position_top;
                componentlogWindow.style.width = window.width;
                componentlogWindow.style.height = window.height;
            }
        }
    }

    componentlogWindow.addEventListener("click", function (event) {
        event.stopPropagation();
    });
    componentlogWindow.addEventListener("mousedown", function () {
        panzoomInstances[appSchema].pause();
        setFocus("false", this.id);
    });

    componentlogWindow.setAttribute(
        "onmousedown",
        "clearComponentsSelection()"
    );
    div.setAttribute(
        "ondblclick",
        "openLogWindow('" + componentlogWindow.id + "' ,'" + div.id + "');"
    );
    div.addEventListener("contextmenu", function (event) {
        toggleOpenSchemaGPT(event, box.id, div.id);
    });

    let loggerTableTitle = document.createElement("p");
    loggerTableTitle.textContent =
        "Log of component: " + idName + " " + divIdIndex;
    loggerTableTitle.setAttribute(
        "style",
        "text-align: center; width: max-content; margin: 0 auto; margin-top: 20px; color: white;"
    );

    componentlogWindow.appendChild(loggerTableTitle);
    box.appendChild(componentlogWindow);
    box.appendChild(div);

    var logPinIcon = document.createElement("a");
    logPinIcon.setAttribute(
        "style",
        "background-repeat: no-repeat; width: 25px; height: 25px; display: block; position: absolute; top: 5px; left: 5px; cursor: pointer;"
    );
    logPinIcon.style.backgroundImage = isFixed
        ? "url('../../static/icons/pin_window_completed_icon.svg')"
        : "url('../../static/icons/pin_window_icon.svg')";

    isFixed == true
        ? $(componentlogWindow).draggable({ disabled: true })
        : $(componentlogWindow).draggable(
              {
                  disabled: false,
                  cancel: "p, .datasets-table",
              },
              generateDragConfig(box)
          );

    logPinIcon.addEventListener("click", function () {
        isFixed = !isFixed;
        if (isFixed == true) {
            $parentElement = this.parentElement;
            $(this.parentElement).draggable({
                disabled: true,
            });
            logPinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_completed_icon.svg')";
        } else {
            $(this.parentElement).draggable(
                {
                    disabled: false,
                    cancel: "p, .datasets-table",
                },
                generateDragConfig(box)
            );
            logPinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_icon.svg')";
        }
    });

    componentlogWindow.appendChild(logPinIcon);

    var closeWindow = document.createElement("span");
    closeWindow.addEventListener("mouseover", function () {
        $parent = $(closeWindow.parentElement);
        $parent.resizable("disable");
    });
    closeWindow.addEventListener("mouseout", function () {
        $parent = $(closeWindow.parentElement);
        $parent.resizable("enable");
    });
    closeWindow.setAttribute("id", "log_close_" + idName + "-xx-" + divIdIndex);
    closeWindow.setAttribute("class", "close-messagebar");
    closeWindow.setAttribute(
        "onclick",
        "closeComponentMenu('" + componentlogWindow.id + "');"
    );
    componentlogWindow.appendChild(closeWindow);

    var table = document.createElement("table");
    table.setAttribute("id", "logger_table_" + idName + "-xx-" + divIdIndex);
    table.setAttribute(
        "style",
        "display:block; height: calc(100% - 44px); width:100%; overflow-y:auto; z-index:3;"
    );

    table.setAttribute("class", "app_analysis_table");

    componentlogWindow.appendChild(table);
    $("[id='" + componentlogWindow.id + "']")
        .draggable(
            {
                containment: "parent",
                cancel: "p, .datasets-table",
            },
            generateDragConfig(box)
        )
        .resizable({
            handles: "n, e, s, w",
        });

    /*
  Criando janela de ajuda
  */
    helpWindow = document.createElement("div");
    helpWindow.setAttribute("id", "helpwindow_" + idName + "-xx-" + divIdIndex);
    helpWindow.addEventListener("click", function (event) {
        if (panzoomInstances[appSchema] != undefined) {
            panzoomInstances[appSchema].pause();
        } else if (panzoomInstances[schemasAliases[appSchema]] != undefined) {
            panzoomInstances[schemasAliases[appSchema]].pause();
        }
        event.stopPropagation();
    });
    helpWindow.addEventListener("mousedown", function () {
        panzoomInstances[appSchema].pause();

        setFocus("false", this.id);
    });
    helpWindow.style =
        "overflow: hidden; width: 600px; height: 450px;  border-radius: 7px 7px 7px 7px; position: absolute;  display: none;" +
        "background: linear-gradient(#000000, #141414); opacity: 0.8; z-index: 100;  -webkit-animation: fadein 0.2s; animation: fadein 0.2s;";
    helpWindow.setAttribute("onmousedown", "clearComponentsSelection()");
    box.appendChild(helpWindow);
    $("[id='" + helpWindow.id + "']").draggable(
        {
            containment: "parent",
        },
        generateDragConfig(box)
    );

    //Cria botão de fechar do janela de ajuda
    var menuCloseButton = document.createElement("img");
    menuCloseButton.setAttribute(
        "id",
        "helpwindow_close_" + idName + "-xx-" + divIdIndex
    );
    menuCloseButton.setAttribute(
        "onclick",
        "closeComponentMenu('" + helpWindow.id + "');"
    );
    menuCloseButton.setAttribute("src", "../static/img/close_red.png");
    menuCloseButton.style =
        "cursor: pointer; width: 15px; height: 15px; position: absolute; left: 5px; top: 5px;";
    menuCloseButton.title = "Close help window";
    helpWindow.appendChild(menuCloseButton);

    //tag com nome do componente
    var ptag = document.createElement("p");
    //ptag.setAttribute("style", "cursor: context-menu; position: absolute; top: 10px;");
    ptag.setAttribute("style", "cursor: context-menu; margin-top: 5px;");
    ptag.innerHTML = idName.toString();
    div.appendChild(ptag);

    /*
  Elemento que abre menu de parâmetros
  */
    var abrir = document.createElement("img");
    abrir.setAttribute("id", "open_menu_div_" + idName + "-xx-" + divIdIndex);
    abrir.setAttribute(
        "onclick",
        "openComponentMenu('" +
            parametersWindowWrapper.id +
            "' ,'" +
            div.id +
            "' ,'" +
            JSON.stringify(componentParameters).replace(
                /[\/\(\)\']/g,
                "&apos;"
            ) +
            "');"
    );
    abrir.setAttribute("src", parametersIconUrl);
    abrir.title = "Open parameters";
    abrir.style =
        "cursor: pointer; position: absolute; left: 2px; bottom: 5px; width: 21px; height: 21px;";
    div.appendChild(abrir);

    var graphElement = document.createElement("img");
    graphElement.setAttribute(
        "id",
        "graph_icon_" + idName + "-xx-" + divIdIndex
    );
    graphElement.setAttribute(
        "onclick",
        "openLogWindow('" + componentlogWindow.id + "' ,'" + div.id + "');"
    );
    graphElement.setAttribute("src", "../static/img/graph_icon.png");
    graphElement.style =
        "cursor: pointer; position: absolute; right: 3px; bottom: 4px; width: 22px; height: 22px;";
    div.appendChild(graphElement);

    /*
  Elemento que aponta erro no componente
  */
    var errorElement = document.createElement("img");
    errorElement.setAttribute(
        "id",
        "comp_error_exclamation_" + idName + "-xx-" + divIdIndex
    );
    errorElement.setAttribute("src", "../static/img/exclamation.png");
    errorElement.style =
        "visibility: hidden; position: absolute; right: 2px; bottom: 4px; width: 22px; height: 22px;";
    div.appendChild(errorElement);

    /*
  Elemento que remove componente
  */
    var closeElement = document.createElement("img");
    closeElement.setAttribute(
        "id",
        "remove_component_div_" + idName + "-xx-" + divIdIndex
    );
    closeElement.setAttribute(
        "onclick",
        "removeComponent('" +
            parametersWindowWrapper.id +
            "' ,'" +
            div.id +
            "' ,'" +
            appSchema +
            "', false, false);"
    );
    closeElement.setAttribute("src", "../static/img/delete.png");
    closeElement.title = "Delete component";
    closeElement.style =
        "cursor: pointer; visibility: hidden; position: absolute; left: -10px; top: -13px; width: 12px; height: 12px;";
    div.appendChild(closeElement);

    /*
  Elemento que abre janela de ajuda
  */
    var helpElement = document.createElement("img");
    helpElement.setAttribute(
        "id",
        "help_icon_component_div_" + idName + "-xx-" + divIdIndex
    );
    helpElement.setAttribute(
        "onclick",
        "openHelpWindow('" + helpWindow.id + "' ,'" + div.id + "');"
    );
    helpElement.setAttribute("src", "../static/img/question-mark.png");
    helpElement.title = "Open help window";
    helpElement.style =
        "cursor: pointer; visibility: hidden; position: absolute; left: 62px; top: -17px; width: 19px; height: 19px;";
    div.appendChild(helpElement);

    idCanvas = null;

    if (idName == "Deep Neural Network") {
        idCanvas = createWindowNN(
            idName,
            divIdIndex,
            panzoomInstances,
            appSchema,
            box,
            j
        );
        if (isCopy) {
            var jsonLayersStr = componentData["parameters"]["layers"];
            var idCanvas =
                "canvas_nn_" + componentData["div_id"].replace(/\s/g, "");
            var jsonLayers = JSON.parse(jsonLayersStr);
            generateNN(jsonLayers, idCanvas);
        }
    }

    //Adicionando o form de parâmetros
    form = createForm(
        componentTemplate,
        componentParameters,
        idName,
        divIdIndex,
        componentData["parameters"]["name"],
        idCanvas
    );
    divinside.appendChild(form);

    //Adicionando escrita na janela de ajuda
    createHelpText(componentTemplate, idName, divIdIndex);

    /*
  Criando elemento do JSPLUMP
  */
    j.Defaults.Overlays = [
        [
            "Arrow",
            {
                location: 1,
                id: "arrow",
                length: 25,
                foldback: 0.8,
            },
        ],
    ];
    j.ready(function () {
        var common = {
            //isSource: true,
            //isTarget: true,
            connector: [
                "Flowchart",
                {
                    stub: [10, 10],
                    gap: 7,
                    cornerRadius: 15,
                    alwaysRespectStubs: true,
                },
            ],
            endpoint: "Dot",
            maxConnections: numOfConnections,
            paintStyle: { lineWidth: 1 },
            connectorStyle: {
                outlineStroke: styleComp["line-color"],
                strokeWidth: 0,
            },
            endpointStyle: {
                fill: styleComp["endpoint-color"],
                radius: 7,
                outlineStroke: styleComp["endpoint-color"],
                outlineWidth: 1,
            },
        };
        if (componentTemplate["component_type"] != "output") {
            j.addEndpoint(
                div.id,
                {
                    anchor: "Right",
                    isSource: true,
                    isTarget: false,
                    uuid: idName + "-xx-" + divIdIndex + "_0",
                },
                common
            );
        }
        if (componentTemplate["component_type"] != "input") {
            j.addEndpoint(
                div.id,
                {
                    anchor: "Left",
                    isSource: false,
                    isTarget: true,
                    uuid: idName + "-xx-" + divIdIndex + "_1",
                },
                common
            );
        }
        j.draggable(div.id, { containment: "parent" });
    });

    /*
  Criando elemento do JSPLUMP para janela de componente
  */
}

function createComponent(idName, appSchema, pos, undoRedoSchema) {
    var parametersIconUrl = "";
    jsInstances[appSchema] != undefined
        ? (j = jsInstances[appSchema])
        : (j = jsInstances[schemasAliases[appSchema]]);

    document.getElementById("box_item_" + appSchema) != null
        ? (element = document.getElementById("box_item_" + appSchema))
        : (element = document.getElementById(
              "box_item_" + schemasAliases[appSchema]
          ));

    currentTop = element.getBoundingClientRect().top;
    currentLeft = element.getBoundingClientRect().left;
    if (pos == "none") {
        compTop = 512 - currentTop;
        compLeft = 512 - currentLeft;
    } else {
        compTop = pos[1];
        compLeft = pos[0];
    }

    styleComp = {};
    //Contador para identificar unicamente os components *REPENSAR COMO FAZER
    count++;
    //divId = idName + "-" + count.toString()
    componentsTemplates = getComponentsTemplates(); //Pegando JSON lido
    //Template do componente atual
    componentTemplate = componentsTemplates[idName];

    //nativeComponents é variável de applicationsControl
    if (nativeComponents.includes(idName)) {
        parametersIconUrl = componentsIconsType[componentTemplate["icon_type"]];
        styleComp = styleCompNative;
    } else {
        parametersIconUrl = componentsIconsType["My Components"];

        styleComp = styleCompCustom;
    }

    /*
  Criando DIV principal do componente
  */
    var box;
    document.getElementById("box_item_" + appSchema) != null
        ? (box = document.getElementById("box_item_" + appSchema))
        : (box = document.getElementById(
              "box_item_" + schemasAliases[appSchema]
          ));

    //var box = document.getElementById(appSchema);
    var conteudo = box.innerHTML;
    var div = document.createElement("div");
    div.setAttribute("class", "item");

    if ("help" in componentTemplate) {
        div.setAttribute("title", componentTemplate["help"]);
    } else {
        div.setAttribute("title", idName);
    }
    //Armazenar do componente: name, id_name, e div id
    div.setAttribute("class", "item");
    div.setAttribute("id", idName + "-xx-" + count.toString());
    //div.setAttribute("style", "font-size:11px; width: 70px; height: 70px; padding: 0%; position: absolute; background-color:" + styleComp["color"] + "; float: left; color: white; text-align: center; border-radius: 7px; left:" + compLeft.toString() + "px; top:" + compTop.toString() + "px;");
    div.setAttribute(
        "style",
        "font-size:11px; width: 70px; height: 70px; padding: 0%; position: absolute; background: linear-gradient(" +
            styleComp["color-grad"] +
            "," +
            styleComp["color"] +
            "); float: left; color: white; text-align: center; border-radius: 7px; left:" +
            compLeft.toString() +
            "px ; top:" +
            compTop.toString() +
            "px;"
    );
    div.setAttribute(
        "onmousedown",
        "selectComponent(event,'" + div.id + "' ,'" + appSchema + "');"
    );

    var parametersWindowWrapper = document.createElement("div");
    parametersWindowWrapper.setAttribute("class", "parametersMenu");
    parametersWindowWrapper.style.zIndex = "100";
    parametersWindowWrapper.setAttribute(
        "id",
        "wrapper_menu_" + idName + "-xx-" + count.toString()
    );
    divinside = document.createElement("div");

    let isFixed = false;

    var pinIcon = document.createElement("a");
    pinIcon.setAttribute(
        "style",
        "z-index: 10; background-repeat: no-repeat; width: 25px; height: 25px; display: block; position: absolute; top: 5px; left: 5px; cursor: pointer;"
    );
    pinIcon.style.backgroundImage =
        "url('../../static/icons/pin_window_icon.svg')";

    pinIcon.addEventListener("click", function () {
        isFixed = !isFixed;
        if (isFixed == true) {
            $parentElement = this.parentElement;
            $(this.parentElement).draggable({
                disabled: true,
            });
            pinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_completed_icon.svg')";
        } else {
            $(this.parentElement).draggable(generateDragConfig(box));
            pinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_icon.svg')";
        }
    });
    parametersWindowWrapper.appendChild(pinIcon);
    var menuCloseButton = document.createElement("span");
    menuCloseButton.setAttribute(
        "id",
        "menu_close_" + idName + "-xx-" + count.toString()
    );
    menuCloseButton.setAttribute(
        "onclick",
        "closeComponentMenu('" + parametersWindowWrapper.id + "');"
    );
    menuCloseButton.setAttribute("class", "close-messagebar");
    menuCloseButton.title = "Close and keep parameters";
    parametersWindowWrapper.appendChild(menuCloseButton);
    /*
  Criando menu de parâmetros (DIV)
  */
    divinside = document.createElement("div");
    divinside.setAttribute("id", "menu_" + idName + "-xx-" + count.toString());
    divinside.addEventListener("click", function (event) {
        if (panzoomInstances[appSchema] != undefined) {
            panzoomInstances[appSchema].pause();
        } else if (panzoomInstances[schemasAliases[appSchema]] != undefined) {
            panzoomInstances[schemasAliases[appSchema]].pause();
        }
        event.stopPropagation();
    });
    parametersWindowWrapper.appendChild(divinside);
    parametersWindowWrapper.addEventListener("mousedown", function () {
        panzoomInstances[appSchema].pause();

        setFocus("false", this.id);
    });

    //div.setAttribute("ondblclick", "openComponentMenu('" + divinside.id + "' ,'" + div.id + "' ,'" + JSON.stringify(componentTemplate) + "');");
    box.appendChild(parametersWindowWrapper); //Adiciona div do menu a div principal (bloco)
    box.appendChild(div);

    $("[id='" + parametersWindowWrapper.id + "']").draggable(
        {
            containment: "parent",
        },
        generateDragConfig(box)
    );

    // Criar janela de print para componente
    var componentlogWindow;
    isFixed = false;
    componentlogWindow = document.createElement("div");

    componentlogWindow.setAttribute(
        "id",
        "log_" + idName + "-xx-" + count.toString()
    );
    componentlogWindow.addEventListener("click", function (event) {
        event.stopPropagation();
    });
    componentlogWindow.addEventListener("mousedown", function () {
        panzoomInstances[appSchema].pause();

        setFocus("false", this.id);
    });
    componentlogWindow.setAttribute(
        "style",
        "min-width: 400px; width: max-content; max-width: 1400px; height: 400px; max-height: 600px; border: 1px solid #cccccc; border-radius: 12px; position: absolute; display: none; z-index: 100; background-color: black; overflow: visible;  animation: 5s;"
    );

    componentlogWindow.setAttribute(
        "onmousedown",
        "clearComponentsSelection()"
    );
    div.setAttribute(
        "ondblclick",
        "openLogWindow('" + componentlogWindow.id + "' ,'" + div.id + "');"
    );
    div.addEventListener("contextmenu", function (event) {
        toggleOpenSchemaGPT(event, box.id, div.id);
    });

    let loggerTableTitle = document.createElement("p");
    loggerTableTitle.textContent =
        "Log of component: " + idName + " " + count.toString();
    loggerTableTitle.setAttribute(
        "style",
        "text-align: center; width: max-content; margin: 0 auto; margin-top: 20px; color: white;"
    );

    componentlogWindow.appendChild(loggerTableTitle);
    box.appendChild(componentlogWindow);
    box.appendChild(div);
    var logPinIcon = document.createElement("a");
    logPinIcon.setAttribute(
        "style",
        "background-repeat: no-repeat; width: 25px; height: 25px; display: block; position: absolute; top: 5px; left: 5px; cursor: pointer;"
    );
    logPinIcon.style.backgroundImage =
        "url('../../static/icons/pin_window_icon.svg')";

    logPinIcon.addEventListener("click", function () {
        isFixed = !isFixed;
        if (isFixed == true) {
            $parentElement = this.parentElement;
            $(this.parentElement).draggable({
                disabled: true,
            });
            logPinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_completed_icon.svg')";
        } else {
            $(this.parentElement).draggable(generateDragConfig(box));
            logPinIcon.style.backgroundImage =
                "url('../../static/icons/pin_window_icon.svg')";
        }
    });
    componentlogWindow.appendChild(logPinIcon);

    var closeWindow = document.createElement("span");
    closeWindow.addEventListener("mouseover", function () {
        $parent = $(closeWindow.parentElement);
        $parent.resizable("disable");
    });
    closeWindow.addEventListener("mouseout", function () {
        $parent = $(closeWindow.parentElement);
        $parent.resizable("enable");
    });
    closeWindow.setAttribute(
        "id",
        "log_close_" + idName + "-xx-" + count.toString()
    );
    closeWindow.setAttribute("class", "close-messagebar");
    closeWindow.setAttribute(
        "onclick",
        "closeComponentMenu('" + componentlogWindow.id + "');"
    );
    componentlogWindow.appendChild(closeWindow);

    var table = document.createElement("table");
    table.setAttribute(
        "id",
        "logger_table_" + idName + "-xx-" + count.toString()
    );
    table.setAttribute(
        "style",
        "display:block; height: calc(100% - 44px); width:100%; overflow-y:auto; z-index:3;"
    );
    table.setAttribute("class", "app_analysis_table");

    componentlogWindow.appendChild(table);

    /*
  Criando janela de ajuda
  */
    helpWindow = document.createElement("div");

    helpWindow.setAttribute(
        "id",
        "helpwindow_" + idName + "-xx-" + count.toString()
    );
    helpWindow.addEventListener("click", function (event) {
        if (panzoomInstances[appSchema] != undefined) {
            panzoomInstances[appSchema].pause();
        } else if (panzoomInstances[schemasAliases[appSchema]] != undefined) {
            panzoomInstances[schemasAliases[appSchema]].pause();
        }
        event.stopPropagation();
    });

    helpWindow.addEventListener("mousedown", function () {
        panzoomInstances[appSchema].pause();

        setFocus("false", this.id);
    });
    helpWindow.style =
        "overflow: hidden; width: 600px; height: 450px;  border-radius: 7px 7px 7px 7px; position: absolute;  display: none;" +
        "background: linear-gradient(#000000, #141414); opacity: 0.8; z-index: 100;  -webkit-animation: fadein 0.2s; animation: fadein 0.2s;";
    helpWindow.setAttribute("onmousedown", "clearComponentsSelection()");
    box.appendChild(helpWindow);

    $("[id='" + helpWindow.id + "']").draggable(
        {
            containment: "parent",
        },
        generateDragConfig(box)
    );
    //Cria botão de fechar do menu

    //Cria botão de fechar do janela de ajuda
    var menuCloseButton = document.createElement("img");
    menuCloseButton.setAttribute(
        "id",
        "helpwindow_close_" + idName + "-xx-" + count.toString()
    );
    menuCloseButton.setAttribute(
        "onclick",
        "closeComponentMenu('" + helpWindow.id + "');"
    );
    menuCloseButton.setAttribute("src", "../static/img/close_red.png");
    menuCloseButton.style =
        "cursor: pointer; width: 15px; height: 15px; position: absolute; left: 5px; top: 5px;";
    menuCloseButton.title = "Close help window";
    helpWindow.appendChild(menuCloseButton);

    idCanvas = null;
    if (idName == "Deep Neural Network") {
        idCanvas = createWindowNN(
            idName,
            count.toString(),
            panzoomInstances,
            appSchema,
            box,
            j
        );
    }

    componentTemplate["name"] = idName + " " + count.toString();
    componentParameters = {};
    form = createForm(
        componentTemplate,
        componentParameters,
        idName,
        count.toString(),
        componentTemplate["name"],
        idCanvas
    );
    divinside.appendChild(form);

    //Adicionando escrita na janela de ajuda
    createHelpText(componentTemplate, idName, count.toString());

    //tag com nome do componente
    var ptag = document.createElement("p");
    ptag.setAttribute("style", "cursor: context-menu; margin-top: 5px;");
    ptag.innerHTML = idName.toString();
    div.appendChild(ptag);

    /*
  Fim da criação do menu de parâmetros
  */

    /*
  Elemento que abre menu de parâmetros
  */
    var abrir = document.createElement("img");
    //  abrir.setAttribute("class", "open_menu_div_" + idName + "-" + count.toString());
    abrir.setAttribute(
        "onclick",
        "openComponentMenu('" +
            parametersWindowWrapper.id +
            "' ,'" +
            div.id +
            "' ,'" +
            JSON.stringify(componentParameters).replace(
                /[\/\(\)\']/g,
                "&apos;"
            ) +
            "');"
    );
    abrir.setAttribute("src", parametersIconUrl);
    abrir.title = "Open parameters";
    abrir.style =
        "cursor: pointer; position: absolute; left: 2px; bottom: 5px; width: 21px; height: 21px;";
    div.appendChild(abrir);

    var graphElement = document.createElement("img");
    graphElement.setAttribute(
        "id",
        "graph_icon_" + idName + "-xx-" + count.toString()
    );
    graphElement.setAttribute("src", "../static/img/graph_icon.png");
    graphElement.setAttribute(
        "onclick",
        "openLogWindow('" + componentlogWindow.id + "' ,'" + div.id + "');"
    );
    graphElement.style =
        "cursor: pointer; position: absolute; right: 3px; bottom: 4px; width: 22px; height: 22px;";
    div.appendChild(graphElement);

    /*
  Elemento que aponta erro no componente
  */
    var errorElement = document.createElement("img");
    errorElement.setAttribute(
        "id",
        "comp_error_exclamation_" + idName + "-xx-" + count.toString()
    );
    errorElement.setAttribute("src", "../static/img/exclamation.png");
    errorElement.style =
        "visibility: hidden; position: absolute; right: 2px; bottom: 4px; width: 22px; height: 22px;";
    div.appendChild(errorElement);

    /*
  Elemento que remove componente
  */
    var closeElement = document.createElement("img");
    closeElement.setAttribute(
        "id",
        "remove_component_div_" + idName + "-xx-" + count.toString()
    );
    closeElement.setAttribute(
        "onclick",
        "removeComponent('" +
            parametersWindowWrapper.id +
            "' ,'" +
            div.id +
            "' ,'" +
            appSchema +
            "', false, false);"
    );
    closeElement.setAttribute("src", "../static/img/delete.png");
    closeElement.title = "Delete component";
    closeElement.style =
        "cursor: pointer; visibility: hidden; position: absolute; left: -10px; top: -13px; width: 12px; height: 12px;";
    div.appendChild(closeElement);

    /*
  Elemento que abre janela de ajuda
  */
    var helpElement = document.createElement("img");
    helpElement.setAttribute(
        "id",
        "help_icon_component_div_" + idName + "-xx-" + count.toString()
    );
    helpElement.setAttribute(
        "onclick",
        "openHelpWindow('" + helpWindow.id + "' ,'" + div.id + "');"
    );
    helpElement.setAttribute("src", "../static/img/question-mark.png");
    helpElement.title = "Open help window";
    helpElement.style =
        "cursor: pointer; visibility: hidden; position: absolute; left: 62px; top: -17px; width: 19px; height: 19px;";
    div.appendChild(helpElement);

    /*
  Criando elemento do JSPLUMP
  */

    j.Defaults.Overlays = [
        [
            "Arrow",
            {
                location: 1,
                id: "arrow",
                length: 25,
                foldback: 0.8,
            },
        ],
    ];
    j.ready(function () {
        var common = {
            //isSource: true,
            //isTarget: true,
            connector: [
                "Flowchart",
                {
                    stub: [10, 10],
                    gap: 7,
                    cornerRadius: 15,
                    alwaysRespectStubs: true,
                },
            ],
            endpoint: "Dot",
            maxConnections: numOfConnections,
            paintStyle: { lineWidth: 1 },
            connectorStyle: {
                outlineStroke: styleComp["line-color"],
                strokeWidth: 0,
            },
            endpointStyle: {
                fill: styleComp["endpoint-color"],
                radius: 7,
                outlineStroke: styleComp["endpoint-color"],
                outlineWidth: 1,
            },
            //connectorStyle: {outlineStroke: "#ce007f", strokeWidth: 1},
            //endpointStyle: {fill: "#510d1e", outlineStroke: "#510d2e", outlineWidth: 2},
            //allowLoopback:false,
            //connectionsDetachable:true
        };

        if (componentTemplate["component_type"] != "output") {
            j.addEndpoint(
                div.id,
                {
                    anchor: "Right",
                    isSource: true,
                    isTarget: false,
                },
                common
            );
        }
        if (componentTemplate["component_type"] != "input") {
            j.addEndpoint(
                div.id,
                {
                    anchor: "Left",
                    isSource: false,
                    isTarget: true,
                },
                common
            );
        }
        //jsPlumb.makeTarget(div.id, {
        //anchor: "Right",
        //    allowLoopback:false,
        //    connectionsDetachable:true
        //}, common);

        j.draggable(div.id, { containment: "parent" });
    });

    /*
  Criando elemento do JSPLUMP para janela de componente
  */

    if (componentlogWindow != undefined) {
        $("[id='" + componentlogWindow.id + "']")
            .draggable(
                {
                    cancel: "p, .datasets-table",
                },
                generateDragConfig(box)
            )
            .resizable({ handles: "n, e, s, w" });
    }

    updateSchemas();

    var undoRedoJson = {};
    undoRedoJson["position"] = pos;
    undoRedoJson["divId"] = idName + "-xx-" + count.toString();

    if (undoRedoSchema) {
        appSchema = schemasAliases[undoRedoSchema]
            ? schemasAliases[undoRedoSchema]
            : undoRedoSchema;
    } else {
        appSchema = schemasAliases[appSchema]
            ? schemasAliases[appSchema]
            : appSchema;
    }

    undoRedoJson["schema"] = appSchema;
    var info = {
        createComponent: undoRedoJson,
    };

    if (undoCommands.length == 5) undoCommands.pop();

    undoCommands.unshift(info);
}

/*
Abre janela de ajuda
*/
function openHelpWindow(id, idComp) {
    setOnclickInputs(idComp);
    setFocus("false", id);

    //Primeiro passo é tirar a seleção de todos os componentes, caso exista
    for (i = 0; i < selectedComponents.length; i++) {
        var $componentElem = $(document.getElementById(selectedComponents[i]));
        $componentElem.css("outline-style", "none");
        jsInstance.removeFromDragSelection($componentElem);
        compRemoveElement = document.getElementById(
            "remove_component_div_" + selectedComponents[i]
        );
        if (compRemoveElement != null) {
            compRemoveElement.style.visibility = "hidden";
        }
        compHelpElement = document.getElementById(
            "help_icon_component_div_" + selectedComponents[i]
        );
        if (compHelpElement != null) {
            compHelpElement.style.visibility = "hidden";
        }
    }

    var menuComponents = document.getElementById(id);
    var component = document.getElementById(idComp);

    menuComponents.style.display = "block";
    menuComponents.style.top = component.style.top;
    menuComponents.style.left = component.style.left;
    //componentSchema = component.parentNode.id.split("box_item_")[1]
    //panzoomInstances[componentSchema].pause();
    //menusOpenedSchemas[componentSchema] = menusOpenedSchemas[componentSchema] + 1;

    //Ajusta o lado direito e abaixo

    var bounding = menuComponents.getBoundingClientRect();
    if (bounding.right > window.innerWidth) {
        leftValue = parseInt(menuComponents.style.left.replace("px", ""));
        leftValue = leftValue - (bounding.right - window.innerWidth);
        menuComponents.style.left = leftValue.toString() + "px";
    }
    if (bounding.bottom > window.innerHeight) {
        topValue = parseInt(menuComponents.style.top.replace("px", ""));
        topValue = topValue - (bounding.bottom - window.innerHeight);
        menuComponents.style.top = topValue.toString() + "px";
    }
}

function openLogWindow(id, idComp) {
    setOnclickInputs(idComp);
    setFocus("false", id);

    //Primeiro passo é tirar a seleção de todos os componentes, caso exista
    for (i = 0; i < selectedComponents.length; i++) {
        var $componentElem = $(document.getElementById(selectedComponents[i]));
        $componentElem.css("outline-style", "none");
        jsInstance.removeFromDragSelection($componentElem);
        compRemoveElement = document.getElementById(
            "remove_component_div_" + selectedComponents[i]
        );
        if (compRemoveElement != null) {
            compRemoveElement.style.visibility = "hidden";
        }
        compHelpElement = document.getElementById(
            "help_icon_component_div_" + selectedComponents[i]
        );
        if (compHelpElement != null) {
            compHelpElement.style.visibility = "hidden";
        }
    }

    var menuComponents = document.getElementById(id);
    var component = document.getElementById(idComp);

    menuComponents.style.display = "block";
    menuComponents.style.top = component.style.top;
    menuComponents.style.left = component.style.left;
    //componentSchema = component.parentNode.id.split("box_item_")[1]
    //panzoomInstances[componentSchema].pause();
    //menusOpenedSchemas[componentSchema] = menusOpenedSchemas[componentSchema] + 1;

    //Ajusta o lado direito e abaixo

    var bounding = menuComponents.getBoundingClientRect();
    if (bounding.right > window.innerWidth) {
        leftValue = parseInt(menuComponents.style.left.replace("px", ""));
        leftValue = leftValue - (bounding.right - window.innerWidth);
        menuComponents.style.left = leftValue.toString() + "px";
    }
    if (bounding.bottom > window.innerHeight) {
        topValue = parseInt(menuComponents.style.top.replace("px", ""));
        topValue = topValue - (bounding.bottom - window.innerHeight);
        menuComponents.style.top = topValue.toString() + "px";
    }
}

/*
Abre o menu de componentes
*/
function openComponentMenu(id, idComp, componentParameters) {
    setFocus("false", id);

    const idName = idComp.split("-xx-")[0];
    setOnclickInputs(idComp);
    //Primeiro passo é tirar a seleção de todos os componentes, caso exista
    for (i = 0; i < selectedComponents.length; i++) {
        var $componentElem = $(document.getElementById(selectedComponents[i]));
        $componentElem.css("outline-style", "none");
        jsInstance.removeFromDragSelection($componentElem);
        compRemoveElement = document.getElementById(
            "remove_component_div_" + selectedComponents[i]
        );
        if (compRemoveElement != null) {
            compRemoveElement.style.visibility = "hidden";
        }
        compHelpElement = document.getElementById(
            "help_icon_component_div_" + selectedComponents[i]
        );
        if (compHelpElement != null) {
            compHelpElement.style.visibility = "hidden";
        }
    }

    // var menuComponentsWrapper = document.getElementById(id).parentNode
    var menuComponents = document.getElementById(id);
    var component = document.getElementById(idComp);

    menuComponents.style.display = "block";
    menuComponents.style.top = component.style.top;
    menuComponents.style.left = component.style.left;
    componentSchema = component.parentNode.id.split("box_item_")[1];
    panzoomInstances[componentSchema].pause();
    menusOpenedSchemas[componentSchema] =
        menusOpenedSchemas[componentSchema] + 1;
    //nSchemas = Object.keys(panzoomInstances).length;
    //schemasNames = Object.keys(panzoomInstances)
    //for (var iSchema = 0; iSchema < nSchemas; iSchema++) {
    //  panzoomInstances[schemasNames[iSchema]].pause();
    //}
    //panzoomInstance.pause();
    //Ajusta o lado direito e abaixo
    var bounding = menuComponents.getBoundingClientRect();
    if (bounding.right > window.innerWidth) {
        leftValue = parseInt(menuComponents.style.left.replace("px", ""));
        leftValue = leftValue - (bounding.right - window.innerWidth);
        menuComponents.style.left = leftValue.toString() + "px";
    }
    if (bounding.bottom > window.innerHeight) {
        topValue = parseInt(menuComponents.style.top.replace("px", ""));
        topValue = topValue - (bounding.bottom - window.innerHeight);
        menuComponents.style.top = topValue.toString() + "px";
    }

    //Se for um campo dataset de Load Data Object, então buscar os nomes de datasets
    if (id.search("Load Data Objects") != -1) {
        var datasets;
        $.getJSON({
            type: "GET",
            url: "/get-datasets",
            dataType: "json",
            success: function (data) {
                datasets = data;
                //Parâmetro dataset
                select_id = id.split("_")[2] + "-xx-dataset";
                var select = document.getElementById(select_id);
                if (select.selectedIndex > -1) {
                    selectedtValue = select.options[select.selectedIndex].text;
                } else {
                    if (loadDataParametersJson == {}) {
                        selectedtValue = "";
                    } else selectedtValue = loadDataParametersJson["dataset"];
                }
                select.innerHTML = "";
                datasets.forEach(function (item) {
                    var option = document.createElement("option");
                    option.text = item;
                    option.value = item;
                    select.appendChild(option);
                });
                select.value = selectedtValue;

                //Parâmetro dataset_learning
                select_id = id.split("_")[2] + "-xx-dataset_learning";
                var select = document.getElementById(select_id);
                if (select.selectedIndex > -1) {
                    selectedtValue = select.options[select.selectedIndex].text;
                } else {
                    if (loadDataParametersJson == {}) {
                        selectedtValue = "";
                    } else
                        selectedtValue =
                            loadDataParametersJson["dataset_learning"];
                }
                select.innerHTML = "";
                datasets.forEach(function (item) {
                    var option = document.createElement("option");
                    option.text = item;
                    option.value = item;
                    select.appendChild(option);
                });
                select.value = selectedtValue;
            },
        });
    } else if (
        id.search("Big Query Input") != -1 ||
        id.search("Big Query Output") != -1
    ) {
        component = id.split("wrapper_menu_")[1].split("-xx-")[0];
        select_id = id.split("_")[2] + "-xx-credentials";
        var select = document.getElementById(select_id);
        data = {
            component: component,
        };

        $.getJSON({
            type: "GET",
            url: "/list-credentials",
            dataType: "text",
            data: JSON.stringify(data),
            success: function (data) {
                credentials = JSON.parse(data);
                if (select.selectedIndex > -1) {
                    selectedtValue = select.options[select.selectedIndex].text;
                } else {
                    if (componentParametersJson == {}) {
                        selectedtValue = "";
                    } else
                        selectedtValue = componentParametersJson["credentials"];
                }
                select.innerHTML = "";
                credentials.forEach(function (item) {
                    var option = document.createElement("option");
                    option.text = item;
                    option.value = item;
                    select.appendChild(option);
                });
                select.value = selectedtValue;
            },
        });
    }
}

/*
Fecha o menu de componentes
*/
function closeComponentMenu(id) {
    componentSchema = document
        .getElementById(id)
        .parentNode.id.split("box_item_")[1];
    menusOpenedSchemas[componentSchema] =
        menusOpenedSchemas[componentSchema] - 1;
    //$("img").click(function () {
    //nSchemas = Object.keys(panzoomInstances).length;
    //schemasNames = Object.keys(panzoomInstances)
    //for (var iSchema = 0; iSchema < nSchemas; iSchema++) {
    //  panzoomInstances[schemasNames[iSchema]].resume();
    //}
    //panzoomInstance.resume();
    document.getElementById(id).style.display = "none";
    //});
}

/*
Converte components e ligações em JSON e envia para uma rota do flask
*/
function updateSchemas() {
    //Inicializando JSON
    //EX: jsonSchemas = {"schema_sentiment": {"components":[...], "connections": [...], "numberOfComponents": 2 } , "schema_collect": flowChart}
    jsonSchemas = {};
    schemasNames = [];

    //NOVO MODO DE OBTER OS SCHEMAS
    tabcontent_schemas = document.getElementsByClassName("tabcontent_schemas");
    for (i = 0; i < tabcontent_schemas.length; i++) {
        nodeSchema = tabcontent_schemas[i].id;
        //Verificar se a chave existe em schemasAliases
        if (nodeSchema in schemasAliases) {
            schemaCurrentName = schemasAliases[nodeSchema];
        } else {
            schemaCurrentName = nodeSchema;
        }

        if (schemasNames.includes(nodeSchema) == false) {
            schemasNames.push(nodeSchema);
        }
        jsonSchemas[schemaCurrentName] = {};
        jsonSchemas[schemaCurrentName]["components"] = [];
        jsonSchemas[schemaCurrentName]["connections"] = [];
        jsonSchemas[schemaCurrentName]["stickers"] = [];
        jsonSchemas[schemaCurrentName]["fixed_windows"] = [];
    }

    //Variável para armazenar correspondecia de div id para nome
    idToName = {};
    componentsTemplates = getComponentsTemplates();
    /*
  Capturar nós (componentes) e suas informações (segmentado por Schema)
  */

    // isValidSchemas = {}

    $(".item").each(function (idx, elem) {
        isValid = true;
        var $elem = $(elem);
        /*
    Serializando informações do formulário
    */
        currentCompId = $elem.attr("id");
        currentComp = $elem.attr("id").split("-xx-")[0];
        parametersTemplate = componentsTemplates[currentComp];
        if (currentComp == "Deep Neural Network") {
            var idCanvas = "canvas_nn_" + currentCompId.replace(/\s/g, "");
            var idName = currentComp.replace(/\s/g, "");
            var divIdIndex = currentCompId.split("-xx-")[1];

            updateLayersSchema(idCanvas, idName, divIdIndex);
        }
        form = document.getElementById("parameters_form_" + $elem.attr("id"));
        //Para cada parametro do template fazer a busca pelo id
        parametersList = Object.keys(parametersTemplate);
        /*
    Para cada parâmetro, fazer a captura de valores nos elementos HTML e colocar
    em um JSON de parâmetros
    */
        parameters = {};

        for (var iParam = 0; iParam < parametersList.length; iParam++) {
            //if (parametersList[iParam]=="help" || parametersList[iParam]=="component_type" || parametersList[iParam]=="input_dim"){
            if (
                parametersList[iParam] == "help" ||
                parametersList[iParam] == "input_dim" ||
                parametersList[iParam] == "help_link" ||
                parametersList[iParam] == "grid_config" ||
                parametersList[iParam] == "icon_type"
            ) {
                continue;
            }
            if (parametersList[iParam] == "component_type") {
                parameters["component_type"] =
                    componentsTemplates[currentComp]["component_type"];
                continue;
            }

            parameterElement = form.querySelector(
                '[name="' + parametersList[iParam] + '"]'
            );

            if (
                typeof componentsTemplates[currentComp][
                    parametersList[iParam]
                ] == "object"
            ) {
                /*
        if ("required" in componentsTemplates[currentComp][parametersList[iParam]]){
          if (componentsTemplates[currentComp][parametersList[iParam]]["required"]==true){
						if (parameterElement.value == ""){
              parameterElement.setAttribute("style","border-style: solid");
              parameterElement.setAttribute("style","border-color: red");
              $elem.css("outline-style","solid");
              $elem.css("outline-color","red");
              $elem.css("outline-radius","9px");
	            isValid = false;
						}
						else{
              parameterElement.setAttribute("style","border-style: transparent");
              //Se ainda for válido, manter sem contorno,
              //caso já tenha invalidado em outro parâmetro, não faz nada e mantém
              //o contorno
              if (isValid == true){
                 $elem.css("outline-style","none")
              }
					 }
          }
        }
        */
                if (
                    "select" in
                    componentsTemplates[currentComp][parametersList[iParam]]
                ) {
                    if (
                        componentsTemplates[currentComp][
                            parametersList[iParam]
                        ]["select"].length == 2 &&
                        typeof componentsTemplates[currentComp][
                            parametersList[iParam]
                        ]["select"][0] == "boolean"
                    ) {
                        var temp =
                            parameterElement.value.toLowerCase() === "true";
                        parameters[parameterElement.name] = temp;
                    } else {
                        parameters[parameterElement.name] =
                            parameterElement.value;
                    }
                }
                //Se for subform, deve capturar todos os inputs
                else if (
                    "subform" in
                    componentsTemplates[currentComp][parametersList[iParam]]
                ) {
                    parameters[parametersList[iParam]] = [];
                    var subInputsRows =
                        parameterElement.querySelectorAll(".subInputRow");
                    for (var row of subInputsRows) {
                        var subParameters = {};
                        let subInputs = row.querySelectorAll("input");

                        for (var input of subInputs) {
                            subParameters[input.name] = input.value;
                        }
                        parameters[parametersList[iParam]].push(subParameters);
                    }
                }
                // Se for seleção mútlipa com combobox
                else if (
                    "multiselect" in
                        componentsTemplates[currentComp][
                            parametersList[iParam]
                        ] ||
                    "textlist" in
                        componentsTemplates[currentComp][parametersList[iParam]]
                ) {
                    parameters[parametersList[iParam]] = $(
                        "#" + parameterElement.id
                    ).val();
                    let select2 = document.getElementById(
                        "select2-" + parameterElement.id + "-container"
                    );
                    var orderedOptions = [];
                    if (select2) {
                        for (let option of select2.querySelectorAll(
                            "span.select2-selection__choice__display"
                        )) {
                            orderedOptions.push(option.textContent);
                        }
                    }
                    if (
                        "textlist" in
                        componentsTemplates[currentComp][parametersList[iParam]]
                    ) {
                        parameters[parametersList[iParam]] =
                            orderedOptions.join(",");
                    } else parameters[parametersList[iParam]] = orderedOptions;
                }
                //Se for input comum, mas deve ser inserido como lista
                // else if (
                //     "textlist" in
                //     componentsTemplates[currentComp][parametersList[iParam]]
                // ) {
                //     //valueInParam = parameterElement.value;
                //     //if (!(parameterElement.value.includes(","))){
                //     //  valueInParam = valueInParam + ","
                //     //}
                //     //parameters[parameterElement.name] = valueInParam;

                //     parameters[parameterElement.name] = parameterElement.value;
                // }
                //Se for um input comum
                else {
                    parameters[parameterElement.name] = parameterElement.value;
                }
            }
            //Caso não tenha definição nehuma de tipo de parâmetro
            else {
                parameters[parameterElement.name] = parameterElement.value;
            }
        } //Fim do for de parâmetros

        /*
    Adicionando informações sobre o componente
    */
        nodeSchema = document.getElementById($elem.attr("id")).parentNode.id; //Schema é o id da div pai
        nodeSchema = nodeSchema.split("box_item_")[1];
        //Verificar se a chave existe em schemasAliases
        if (nodeSchema in schemasAliases) {
            schemaCurrentName = schemasAliases[nodeSchema];
        } else {
            schemaCurrentName = nodeSchema;
        }
        jsonSchemas[schemaCurrentName]["components"].push({
            div_id: $elem.attr("id"),
            position_left: parseInt($elem.css("left"), 10),
            position_top: parseInt($elem.css("top"), 10),
            parameters: parameters,
        });
        idToName[$elem.attr("id")] = parameters["name"];
        /*
		if (!(schemaCurrentName in isValidSchemas)){
			isValidSchemas[schemaCurrentName] = 0;
		}
		if (isValid==false){
			isValidSchemas[schemaCurrentName] = isValidSchemas[schemaCurrentName] + 1;
		}
    */
    });

    /*
  Capturar arestas (conexões) e suas informações (segmentado por Schema)
  */
    for (var iSchema = 0; iSchema < schemasNames.length; iSchema++) {
        schemaSelected = schemasNames[iSchema];
        $.each(
            jsInstances[schemaSelected].getConnections(),
            function (idx, connection) {
                nodeSchema = document.getElementById(connection.sourceId)
                    .parentNode.id;

                nodeSchema = nodeSchema.split("box_item_")[1];
                //Verificar se a chave existe em schemasAliases
                if (nodeSchema in schemasAliases) {
                    schemaCurrentName = schemasAliases[nodeSchema];
                } else {
                    schemaCurrentName = nodeSchema;
                }
                connLabel = connection.getOverlay("label").label.split("-");

                jsonSchemas[schemaCurrentName]["connections"].push({
                    connection_id: connection.id,
                    source_id: connection.sourceId,
                    target_id: connection.targetId,
                    source_name: idToName[connection.sourceId],
                    target_name: idToName[connection.targetId],
                    connection_index_source: connLabel[0],
                    connection_index_target: connLabel[1],
                    //connection_index: connection.getOverlay("label").label
                });
            }
        );

        /*
            Capturar janelas fixas
        */

        let correctSchemaName = schemasAliases[schemaSelected]
            ? schemasAliases[schemaSelected]
            : schemaSelected;

        let parentElem = document.getElementById("box_item_" + schemaSelected);
        parentElem.querySelectorAll(".item").forEach((element) => {
            const idName = element.id.split("-xx-")[0];
            let parentWrapper = document.getElementById(
                "wrapper_menu_" + element.id
            );
            if (
                parentWrapper.querySelector("a").style.backgroundImage ==
                'url("../../static/icons/pin_window_completed_icon.svg")'
            ) {
                jsonSchemas[correctSchemaName]["fixed_windows"].push({
                    div_id: parentWrapper.id,
                    width: parentWrapper.style.width,
                    height: parentWrapper.style.height,
                    position_left: parentWrapper.style.left,
                    position_top: parentWrapper.style.top,
                });
            }

            let logWindowWrapper = document.getElementById("log_" + element.id);

            if (
                logWindowWrapper.querySelector("a").style.backgroundImage ==
                'url("../../static/icons/pin_window_completed_icon.svg")'
            ) {
                jsonSchemas[correctSchemaName]["fixed_windows"].push({
                    div_id: logWindowWrapper.id,
                    width: logWindowWrapper.style.width,
                    height: logWindowWrapper.style.height,
                    position_left: logWindowWrapper.style.left,
                    position_top: logWindowWrapper.style.top,
                });
            }
        });
    }

    /*
  Capturar sticker e suas informações (tamanho, posição e conteúdo)
  */

    $(".sticker-wrapper").each(function (idx, elem) {
        var $elem = $(elem);
        var id = elem.id;
        var idCount = id.split("-xx-")[1];
        var content = document.getElementById(
            "sticker-content-xx-" + idCount
        ).value;
        nodeSchema = document.getElementById($elem.attr("id")).parentNode.id; //Schema é o id da div pai
        nodeSchema = nodeSchema.split("box_item_")[1];
        //Verificar se a chave existe em schemasAliases
        if (nodeSchema in schemasAliases) {
            schemaCurrentName = schemasAliases[nodeSchema];
        } else {
            schemaCurrentName = nodeSchema;
        }

        jsonSchemas[schemaCurrentName]["stickers"].push({
            sticker_div_id: $elem.attr("id"),
            position_left: parseInt($elem.css("left"), 10),
            position_top: parseInt($elem.css("top"), 10),
            width: $elem.css("width"),
            height: $elem.css("height"),
            color: $elem.css("background-color"),
            content: content,
        });
    });
    setSchemas(jsonSchemas, schemasAliases);
}

/*
Apaga um componente através do ID de sua div
*/
function removeComponent(menuComponentId, divId, schema, isUndo, isMultiple) {
    let idName = divId.split("-xx-")[0];

    var schema_ = schemasAliases[schema] ? schemasAliases[schema] : schema;
    var schemas = getSchemas();
    var undoRedoJson = {};
    undoRedoJson["connections"] = [];

    if (schemas[schema] == undefined) {
        for (var comp in schemas[schema_]["components"]) {
            if (schemas[schema_]["components"][comp]["div_id"] == divId) {
                undoRedoJson["component_info"] =
                    schemas[schema_]["components"][comp];
            }
        }
        for (var con in schemas[schema_]["connections"]) {
            if (
                schemas[schema_]["connections"][con]["source_id"] == divId ||
                schemas[schema_]["connections"][con]["target_id"] == divId
            ) {
                undoRedoJson["connections"].push(
                    schemas[schema_]["connections"][con]
                );
            }
        }
    } else {
        for (var comp in schemas[schema]["components"]) {
            if (schemas[schema]["components"][comp]["div_id"] == divId) {
                undoRedoJson["component_info"] =
                    schemas[schema]["components"][comp];
            }
        }
        for (var con in schemas[schema]["connections"]) {
            if (
                schemas[schema]["connections"][con]["source_id"] == divId ||
                schemas[schema]["connections"][con]["target_id"] == divId
            ) {
                undoRedoJson["connections"].push(
                    schemas[schema]["connections"][con]
                );
            }
        }
    }

    j =
        jsInstances[schema_] != undefined
            ? jsInstances[schema_]
            : jsInstances[schema];

    //IF's para evitar erro de console no jsPlumb
    if (document.getElementById("helpwindow_" + divId)) {
        j.remove("helpwindow_" + divId);
    }

    if (document.getElementById("log_" + divId)) {
        j.remove("log_" + divId);
    }

    //if ternário para validar se existe elemento, isso evita erros de console do jsPlumb
    document.getElementById(divId) ? j.remove(divId) : null;
    document.getElementById(menuComponentId) ? j.remove(menuComponentId) : null;

    undoRedoJson["schemas"] = schemas;
    undoRedoJson["schema"] = schema;

    if (isMultiple == false) {
        var info = {
            removeComponent: undoRedoJson,
        };

        if (!isUndo && !isCut) {
            if (undoCommands.length == 5) undoCommands.pop();

            undoCommands.unshift(info);
        }
    }

    if (
        componentsTemplates[idName]["component_type"] &&
        componentsTemplates[idName]["component_type"] == "model"
    ) {
        messagesLog(
            "Warning! This component may have saved models, if you save your application, they will be deleted."
        );
    }
}
